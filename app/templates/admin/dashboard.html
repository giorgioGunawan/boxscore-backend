<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NBA Boxscore Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Outfit:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a24;
            --bg-hover: #22222e;
            --accent-orange: #ff6b35;
            --accent-blue: #4ecdc4;
            --accent-purple: #a855f7;
            --accent-green: #22c55e;
            --accent-red: #ef4444;
            --accent-yellow: #eab308;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: #2d2d3a;
            --shadow: 0 4px 24px rgba(0, 0, 0, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            background-image:
                radial-gradient(ellipse at 20% 0%, rgba(255, 107, 53, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 100%, rgba(78, 205, 196, 0.06) 0%, transparent 50%);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 3rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--accent-orange), var(--accent-blue));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .logo h1 {
            font-size: 1.75rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--text-primary), var(--text-secondary));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo span {
            font-size: 0.875rem;
            color: var(--text-muted);
            font-weight: 400;
        }

        .season-badge {
            background: var(--bg-card);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            color: var(--accent-blue);
            border: 1px solid var(--border);
        }

        .input-group {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }

        select,
        input[type="text"],
        input[type="number"] {
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Outfit', sans-serif;
            font-size: 0.9375rem;
            min-width: 180px;
            cursor: pointer;
        }

        input[type="number"] {
            width: 80px;
            min-width: 80px;
        }

        select:focus,
        input:focus {
            outline: none;
            border-color: var(--accent-orange);
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1.25rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-family: 'Outfit', sans-serif;
            font-size: 0.9375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        /* Search Component Styles */
        .search-container {
            position: relative;
            display: inline-block;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: var(--shadow);
            margin-top: 4px;
        }

        .search-results.show {
            display: block;
        }

        .search-result-item {
            padding: 0.5rem 1rem;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-item:hover {
            background: var(--bg-hover);
        }

        .search-result-item .player-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .search-result-item .player-team {
            font-size: 0.75rem;
            color: var(--text-muted);
            background: var(--bg-primary);
            padding: 0.1rem 0.3rem;
            border-radius: 4px;
        }

        .action-btn:hover {
            background: var(--bg-hover);
            border-color: var(--accent-orange);
            transform: translateY(-2px);
        }

        .action-btn.small {
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            border-color: var(--accent-green);
        }

        .toast.error {
            border-color: var(--accent-red);
        }

        /* API Tester Section */
        .api-tester {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--border);
            margin-bottom: 1.5rem;
        }

        .api-tester h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .api-tester h3 .method {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            background: rgba(78, 205, 196, 0.2);
            color: var(--accent-blue);
        }

        .result-container {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            max-height: 400px;
            overflow-y: auto;
            display: none;
            border: 1px solid var(--border);
        }

        .result-container.show {
            display: block;
        }

        .result-container pre {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8125rem;
            color: var(--text-secondary);
            white-space: pre-wrap;
            word-break: break-word;
        }

        .result-container .error {
            color: var(--accent-red);
        }

        .result-container .loading {
            color: var(--text-muted);
            font-style: italic;
        }

        .api-path {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            margin-top: 0.75rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .api-path .method-badge {
            background: rgba(78, 205, 196, 0.2);
            color: var(--accent-blue);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.75rem;
        }

        .api-path .path {
            color: var(--accent-orange);
            flex: 1;
        }

        .api-path .copy-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-muted);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
        }

        .api-path .copy-btn:hover {
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 1rem;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-family: 'Outfit', sans-serif;
            font-size: 0.9375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tab:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .tab.active {
            background: var(--accent-orange);
            border-color: var(--accent-orange);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Widget Styles */
        .widgets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1.5rem;
        }

        .widget {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.25rem;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .widget-content {
            flex: 1;
        }

        .widget-apis {
            margin-top: 1rem;
            padding-top: 0.75rem;
            border-top: 1px dashed var(--border);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .widget-apis .api-label {
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
            color: var(--accent-orange);
        }

        .widget-apis code {
            display: block;
            color: var(--text-secondary);
            padding: 0.15rem 0;
        }

        .widget-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .widget-title .badge {
            background: var(--accent-orange);
            color: white;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-size: 0.65rem;
        }

        /* Widget 1: Next Games */
        .next-games-widget .team-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .next-games-widget .team-abbr {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-blue);
        }

        .next-games-widget .team-record {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .next-games-widget .game-row {
            display: flex;
            align-items: center;
            padding: 0.6rem 0;
            border-bottom: 1px solid var(--border);
            font-size: 0.875rem;
        }

        .next-games-widget .game-row:last-child {
            border-bottom: none;
        }

        .next-games-widget .game-vs {
            color: var(--text-muted);
            width: 25px;
        }

        .next-games-widget .game-opponent {
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
        }

        .next-games-widget .game-opponent-record {
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }

        .next-games-widget .game-datetime {
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        /* Widget 2: Season Average */
        .season-avg-widget .player-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .season-avg-widget .player-name {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .season-avg-widget .player-number {
            background: var(--accent-orange);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
        }

        .season-avg-widget .stats-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
        }

        .season-avg-widget .stat {
            background: var(--bg-secondary);
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
        }

        .season-avg-widget .stat-value {
            color: var(--accent-blue);
            font-weight: 600;
        }

        .season-avg-widget .stat-label {
            color: var(--text-muted);
            font-size: 0.7rem;
        }

        /* Widget 3: Last Results */
        .last-results-widget .result-row {
            display: flex;
            align-items: center;
            padding: 0.6rem 0;
            border-bottom: 1px solid var(--border);
            font-size: 0.875rem;
        }

        .last-results-widget .result-row:last-child {
            border-bottom: none;
        }

        .last-results-widget .result-teams {
            flex: 1;
        }

        .last-results-widget .result-score {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
        }

        .last-results-widget .result-score.win {
            color: var(--accent-green);
        }

        .last-results-widget .result-score.loss {
            color: var(--accent-red);
        }

        .last-results-widget .result-date {
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-left: 1rem;
        }

        /* Widget 4: Team Standing */
        .team-standing-widget .team-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-blue);
            margin-bottom: 0.75rem;
        }

        .team-standing-widget .standing-info {
            display: flex;
            align-items: baseline;
            gap: 1rem;
        }

        .team-standing-widget .record {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.75rem;
            font-weight: 700;
        }

        .team-standing-widget .rank {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        /* Widget 5: Player Last Game */
        .player-last-game-widget .player-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .player-last-game-widget .player-name {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .player-last-game-widget .player-number {
            background: var(--accent-orange);
            color: white;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .player-last-game-widget .stats-line {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .player-last-game-widget .stats-line .stat-value {
            color: var(--accent-blue);
            font-weight: 600;
        }

        .player-last-game-widget .game-result {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
        }

        .player-last-game-widget .game-result .score {
            font-weight: 600;
        }

        /* Widget 6: Countdown */
        .countdown-widget .matchup {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            text-align: center;
        }

        .countdown-widget .matchup .vs {
            color: var(--text-muted);
            font-weight: 400;
            margin: 0 0.5rem;
        }

        .countdown-widget .countdown-display {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
        }

        .countdown-widget .countdown-item {
            text-align: center;
        }

        .countdown-widget .countdown-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-orange);
        }

        .countdown-widget .countdown-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .countdown-widget .game-datetime {
            text-align: center;
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 0.75rem;
        }

        .widget-controls {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--border);
            margin-bottom: 1.5rem;
        }

        .widget-controls h3 {
            font-size: 1rem;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--border);
            border-top-color: var(--accent-orange);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Mobile Responsive Improvements */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .logo h1 {
                font-size: 1.5rem;
            }

            .tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
                -webkit-overflow-scrolling: touch;
            }

            .tab {
                white-space: nowrap;
                min-width: auto;
            }

            /* Jobs Grid - Single Column on Mobile */
            .jobs-grid {
                grid-template-columns: 1fr !important;
            }

            /* Touch-Friendly Buttons */
            .action-btn,
            button {
                min-height: 44px;
                padding: 0.875rem 1.25rem;
                font-size: 1rem;
            }

            .action-btn.small {
                min-height: 40px;
                padding: 0.75rem 1rem;
            }

            /* Job Cards */
            .job-card {
                padding: 1rem;
            }

            .job-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }

            .job-actions {
                width: 100%;
                display: flex;
                gap: 0.5rem;
            }

            .job-actions button {
                flex: 1;
            }

            /* Logs Container */
            .logs-container {
                max-height: 300px;
                font-size: 0.8125rem;
            }

            /* Make logs collapsible on mobile */
            .logs-header {
                cursor: pointer;
                user-select: none;
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.75rem;
                background: var(--bg-secondary);
                border-radius: 8px;
                margin-bottom: 0.5rem;
            }

            .logs-header:active {
                background: var(--bg-hover);
            }

            .logs-content.collapsed {
                display: none;
            }

            /* Tables - Convert to Cards on Mobile */
            .cms-table-container {
                overflow: visible;
            }

            .cms-table {
                min-width: 100%;
                border: none;
            }

            /* Hide table headers on mobile */
            .cms-table thead {
                display: none;
            }

            /* Make each row a card */
            .cms-table tbody tr {
                display: block;
                background: var(--bg-secondary);
                border: 1px solid var(--border);
                border-radius: 12px;
                padding: 1rem;
                margin-bottom: 1rem;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            }

            .cms-table tbody tr:hover {
                background: var(--bg-hover);
            }

            /* Make each cell a row in the card */
            .cms-table td {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                padding: 0.5rem 0;
                border: none;
                border-bottom: 1px solid var(--border);
                gap: 1rem;
            }

            .cms-table td:last-child {
                border-bottom: none;
            }

            /* Add labels before each cell using data-label attribute */
            .cms-table td::before {
                content: attr(data-label);
                font-weight: 600;
                color: var(--text-muted);
                font-size: 0.75rem;
                text-transform: uppercase;
                letter-spacing: 0.05em;
                flex-shrink: 0;
                width: 40%;
            }

            /* Style the cell content */
            .cms-table td>* {
                flex: 1;
                text-align: right;
            }

            /* Actions column - full width */
            .cms-table td.actions,
            .cms-table td.sticky-actions {
                flex-direction: column;
                align-items: stretch;
                padding-top: 0.75rem;
                margin-top: 0.5rem;
                border-top: 1px dashed var(--border);
            }

            .cms-table td.actions::before,
            .cms-table td.sticky-actions::before {
                content: 'Actions';
                width: 100%;
                text-align: center;
                margin-bottom: 0.5rem;
            }

            .cms-table td.actions>div,
            .cms-table td.sticky-actions>div {
                width: 100%;
                display: flex;
                gap: 0.5rem;
                justify-content: center;
            }

            .cms-table td.actions button,
            .cms-table td.sticky-actions button {
                flex: 1;
                min-height: 40px;
            }

            /* Status badges - keep inline */
            .cms-table td .status-badge,
            .cms-table td .badge {
                display: inline-block;
            }

            /* Code/monospace content - allow wrapping */
            .cms-table td code,
            .cms-table td .mono {
                word-break: break-all;
                white-space: normal;
            }

            /* Input Groups - Stack on Mobile */
            .input-group {
                flex-direction: column;
                align-items: stretch;
            }

            select,
            input[type="text"],
            input[type="number"] {
                width: 100%;
                min-width: 100%;
            }

            /* Toast Notifications */
            .toast {
                left: 1rem;
                right: 1rem;
                bottom: 1rem;
            }

            /* Sticky Job Status */
            .job-status-sticky {
                position: sticky;
                top: 0;
                z-index: 10;
                background: var(--bg-card);
                padding: 0.75rem;
                border-bottom: 1px solid var(--border);
                margin: -1rem -1rem 1rem -1rem;
            }
        }

        /* Tablet Adjustments */
        @media (max-width: 1024px) and (min-width: 769px) {
            .jobs-grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }

            .container {
                padding: 1.5rem;
            }
        }

        /* Large Mobile / Small Tablet */
        @media (max-width: 480px) {
            .logo-icon {
                width: 40px;
                height: 40px;
                font-size: 1.25rem;
            }

            .logo h1 {
                font-size: 1.25rem;
            }

            .season-badge {
                font-size: 0.75rem;
                padding: 0.4rem 0.75rem;
            }

            /* Smaller font sizes for very small screens */
            body {
                font-size: 14px;
            }

            .job-card h3 {
                font-size: 0.9rem;
            }

            .job-meta {
                font-size: 0.75rem;
            }
        }

        /* CMS Styles */
        .cms-tabs {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .cms-tab {
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            font-family: 'Outfit', sans-serif;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .cms-tab:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .cms-tab.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }

        .cms-content {
            display: none;
        }

        .cms-content.active {
            display: block;
        }

        .cms-table-container {
            overflow-x: auto;
            margin-top: 1rem;
        }

        .cms-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .cms-table th {
            text-align: left;
            padding: 0.75rem;
            background: var(--bg-secondary);
            color: var(--text-muted);
            font-weight: 500;
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--border);
        }

        .cms-table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
            color: var(--text-secondary);
            vertical-align: middle;
        }

        /* Fix action column alignment */
        .cms-table td.actions,
        .cms-table td.sticky-actions {
            vertical-align: middle;
            padding: 0.75rem;
            min-width: 200px;
        }

        .cms-table td.actions>div:first-child,
        .cms-table td.sticky-actions>div:first-child {
            display: inline-flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
            vertical-align: middle;
        }

        .cms-table td.actions .btn-edit,
        .cms-table td.actions .btn-delete,
        .cms-table td.sticky-actions .btn-edit,
        .cms-table td.sticky-actions .btn-delete {
            margin: 0;
            flex-shrink: 0;
            vertical-align: middle;
        }

        /* Ensure action column header has same styling */
        #cron-runs-table th.actions-header,
        #cron-jobs-table th.sticky-actions {
            background: var(--bg-secondary);
            color: var(--text-muted);
            font-weight: 500;
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--border);
        }

        /* CRON TABLES - Force consistent middle alignment for ALL cells */
        #cron-jobs-table td,
        #cron-runs-table td {
            vertical-align: middle !important;
            padding: 0.75rem !important;
        }

        /* Action column cells - same middle alignment, ensure it works with multi-line cells */
        #cron-jobs-table td.sticky-actions,
        #cron-runs-table td:last-child {
            vertical-align: middle !important;
            padding: 0.75rem !important;
            min-width: 250px;
        }

        /* Button container - inline-flex to keep buttons on same baseline */
        #cron-jobs-table td.sticky-actions>div,
        #cron-runs-table td:last-child>div:first-child {
            display: inline-flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
            vertical-align: middle;
            line-height: 1.5;
        }

        /* Error message - separate line below buttons, doesn't affect button alignment */
        #cron-runs-table td:last-child>div:last-child:not(:first-child) {
            display: block;
            margin-top: 0.5rem;
            white-space: normal;
            line-height: 1.4;
        }

        /* Buttons - consistent inline-block alignment */
        #cron-jobs-table td.sticky-actions .btn-edit,
        #cron-jobs-table td.sticky-actions .btn-delete,
        #cron-runs-table td:last-child .btn-edit,
        #cron-runs-table td:last-child .btn-delete {
            display: inline-block;
            vertical-align: middle;
            margin: 0;
            line-height: 1.5;
        }

        /* CRON JOBS TABLE - Specific fixes for action column alignment */
        #cron-jobs-table tbody tr {
            display: table-row;
        }

        /* Force action column to align middle with other cells */
        #cron-jobs-table td.sticky-actions {
            display: table-cell !important;
            vertical-align: middle !important;
            text-align: center !important;
            padding: 0.75rem !important;
            line-height: normal !important;
        }

        /* Button container - center aligned */
        #cron-jobs-table td.sticky-actions>div {
            display: inline-flex !important;
            gap: 0.5rem !important;
            align-items: center !important;
            justify-content: center !important;
            vertical-align: middle !important;
            margin: 0 !important;
            padding: 0 !important;
            line-height: 1.5 !important;
        }

        /* Ensure buttons are properly aligned - same height as other cell content */
        #cron-jobs-table td.sticky-actions .btn-edit,
        #cron-jobs-table td.sticky-actions .btn-delete {
            vertical-align: middle !important;
            margin: 0 !important;
            display: inline-block !important;
            line-height: 1.5 !important;
            height: auto !important;
        }

        /* Match the line-height of other cells that have <br> tags */
        #cron-jobs-table td:first-child,
        #cron-jobs-table td:nth-child(7) {
            line-height: 1.5;
        }

        .cms-table tr:hover td {
            background: var(--bg-hover);
        }

        .cms-table .actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            white-space: nowrap;
        }

        .cms-table th:last-child,
        .cms-table td:last-child {
            position: sticky;
            right: 0;
            background: var(--bg-card);
            z-index: 10;
        }

        .cms-table tr:hover td:last-child {
            background: var(--bg-hover);
        }

        .cms-table .btn-edit,
        .cms-table .btn-delete {
            padding: 0.35rem 0.65rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
            min-width: 40px;
        }

        .cms-table .btn-edit:hover {
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        .cms-table .btn-delete:hover {
            border-color: var(--accent-red);
            color: var(--accent-red);
        }

        .cms-table input {
            padding: 0.25rem 0.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 0.8rem;
            width: 100%;
        }

        .cms-table input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }

            .tabs {
                flex-wrap: wrap;
            }

            .widgets-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Custom Modal Styles */
        .custom-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 10000;
            animation: fadeIn 0.2s ease;
        }

        .custom-modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .custom-modal {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s ease;
        }

        .custom-modal h3 {
            color: var(--text-primary);
            margin-bottom: 1rem;
            font-size: 1.25rem;
        }

        .custom-modal p {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .custom-modal-buttons {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .custom-modal-buttons button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Outfit', sans-serif;
        }

        .custom-modal-buttons .btn-cancel {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .custom-modal-buttons .btn-cancel:hover {
            background: var(--bg-hover);
        }

        .custom-modal-buttons .btn-confirm {
            background: var(--accent-orange);
            color: white;
        }

        .custom-modal-buttons .btn-confirm:hover {
            background: #ff8559;
        }

        .custom-modal-buttons .btn-confirm.danger {
            background: var(--accent-red);
        }

        .custom-modal-buttons .btn-confirm.danger:hover {
            background: #f87171;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .trigger-cron-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            color: var(--text-primary);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-group input[type="number"] {
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 1rem;
        }

        .form-group input[type="number"]:focus {
            outline: none;
            border-color: var(--accent-orange);
        }

        .form-group .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .form-group .checkbox-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            cursor: pointer;
        }

        /* Info icon tooltip */
        [title] {
            position: relative;
        }

        /* Details view button styling */
        .btn-view-details {
            padding: 0.35rem 0.65rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
            min-width: 60px;
        }

        .btn-view-details:hover {
            background: var(--bg-hover);
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }
    </style>
</head>

<body>
    <!-- Custom Confirmation Modal -->
    <div id="customModalOverlay" class="custom-modal-overlay" onclick="if(event.target === this) closeCustomModal()">
        <div class="custom-modal">
            <h3 id="customModalTitle">Confirm Action</h3>
            <p id="customModalMessage">Are you sure you want to proceed?</p>
            <div class="custom-modal-buttons">
                <button class="btn-cancel" onclick="closeCustomModal()">Cancel</button>
                <button class="btn-confirm" id="customModalConfirm" onclick="confirmCustomModal()">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Modal for triggering cron jobs with options -->
    <div id="triggerCronModalOverlay" class="custom-modal-overlay"
        onclick="if(event.target === this) closeTriggerCronModal()">
        <div class="custom-modal" style="max-width: 600px;">
            <h3 id="triggerCronModalTitle">‚ñ∂Ô∏è Trigger Cron Job</h3>
            <p id="triggerCronModalMessage">Configure options and confirm to run this job immediately.</p>
            <div id="triggerCronModalContent" style="margin-bottom: 1.5rem;">
                <!-- Content will be dynamically inserted here -->
            </div>
            <div class="custom-modal-buttons">
                <button class="btn-cancel" onclick="closeTriggerCronModal()">Cancel</button>
                <button class="btn-confirm" id="triggerCronModalConfirm" onclick="confirmTriggerCronModal()">Run
                    Now</button>
            </div>
        </div>
    </div>

    <!-- Modal for viewing cron run details -->
    <div id="runDetailsModalOverlay" class="custom-modal-overlay"
        onclick="if(event.target === this) closeRunDetailsModal()">
        <div class="custom-modal" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <h3 id="runDetailsModalTitle">üìã Cron Run Details</h3>
            <div id="runDetailsModalContent" style="margin-bottom: 1.5rem;">
                <pre id="runDetailsModalJson"
                    style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; overflow-x: auto; font-size: 0.85rem; line-height: 1.5; color: var(--text-primary); white-space: pre-wrap; word-wrap: break-word;"></pre>
            </div>
            <div class="custom-modal-buttons">
                <button class="btn-cancel" onclick="closeRunDetailsModal()">Close</button>
            </div>
        </div>
    </div>

    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">üèÄ</div>
                <div>
                    <h1>Boxscore Admin</h1>
                    <span>NBA Data Management Console</span>
                </div>
            </div>
            <div class="season-badge">Season {{ settings.current_season }}</div>
        </header>

        <!-- Tabs Navigation -->
        <div class="tabs">
            <button class="tab active" data-tab="widgets">üì± Widgets</button>
            <button class="tab" data-tab="api-tester">üß™ API Tester</button>
            <button class="tab" data-tab="data-management">‚úèÔ∏è Data Management</button>
            <button class="tab" data-tab="cache-metrics">‚ö° Cache & Metrics</button>
            <button class="tab" data-tab="cron-management">‚è∞ Cron Management</button>
        </div>

        <!-- Widgets Tab -->
        <div class="tab-content active" id="tab-widgets">
            <!-- Widget Controls -->
            <div class="widget-controls">
                <h3>üéÆ Widget Preview Controls</h3>
                <div class="input-group">
                    <select id="widget-team">
                        {% for team in teams %}
                        <option value="{{ team.id }}" data-abbr="{{ team.abbreviation }}" {% if team.abbreviation=='GSW'
                            %}selected{% endif %}>{{ team.name }} ({{ team.abbreviation }})</option>
                        {% endfor %}
                    </select>
                    <div class="search-container">
                        <input type="text" id="widget-player-search" placeholder="Search Player..." autocomplete="off">
                        <input type="hidden" id="widget-player-id" value="201939">
                        <div id="widget-player-results" class="search-results"></div>
                    </div>
                    <button class="action-btn small" onclick="loadAllWidgets()">
                        <span class="icon">üîÑ</span> Load Widgets
                    </button>
                </div>
                <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">
                    üí° Default: GSW + Stephen Curry (201939). Change team/player and click Load.
                </p>
            </div>

            <!-- Widgets Grid -->
            <div class="widgets-grid">
                <!-- Widget 1: Next 3 Games -->
                <div class="widget next-games-widget" id="widget-next-games">
                    <div class="widget-title"><span class="badge">1</span> Next 3 Games</div>
                    <div class="widget-content">
                        <div class="loading-spinner"></div> Loading...
                    </div>
                    <div class="widget-apis">
                        <div class="api-label">APIs Used:</div>
                        <code>/api/teams/{id}/next-games?count=3</code>
                        <code>/api/teams/{id}/standings</code>
                    </div>
                </div>

                <!-- Widget 2: Season Average -->
                <div class="widget season-avg-widget" id="widget-season-avg">
                    <div class="widget-title"><span class="badge">2</span> Season Average</div>
                    <div class="widget-content">
                        <div class="loading-spinner"></div> Loading...
                    </div>
                    <div class="widget-apis">
                        <div class="api-label">APIs Used:</div>
                        <code>/api/players/{nba_id}/season-averages</code>
                    </div>
                </div>

                <!-- Widget 3: Last 3 Results -->
                <div class="widget last-results-widget" id="widget-last-results">
                    <div class="widget-title"><span class="badge">3</span> Last 3 Results</div>
                    <div class="widget-content">
                        <div class="loading-spinner"></div> Loading...
                    </div>
                    <div class="widget-apis">
                        <div class="api-label">APIs Used:</div>
                        <code>/api/teams/{id}/last-games?count=3</code>
                    </div>
                </div>

                <!-- Widget 4: Team Standing -->
                <div class="widget team-standing-widget" id="widget-standing">
                    <div class="widget-title"><span class="badge">4</span> Team Standing</div>
                    <div class="widget-content">
                        <div class="loading-spinner"></div> Loading...
                    </div>
                    <div class="widget-apis">
                        <div class="api-label">APIs Used:</div>
                        <code>/api/teams/{id}/standings</code>
                    </div>
                </div>

                <!-- Widget 5: Player Last Game -->
                <div class="widget player-last-game-widget" id="widget-player-last">
                    <div class="widget-title"><span class="badge">5</span> Player Last Game</div>
                    <div class="widget-content">
                        <div class="loading-spinner"></div> Loading...
                    </div>
                    <div class="widget-apis">
                        <div class="api-label">APIs Used:</div>
                        <code>/api/players/{nba_id}/latest-game</code>
                    </div>
                </div>

                <!-- Widget 6: Countdown -->
                <div class="widget countdown-widget" id="widget-countdown">
                    <div class="widget-title"><span class="badge">6</span> Countdown to Next Game</div>
                    <div class="widget-content">
                        <div class="loading-spinner"></div> Loading...
                    </div>
                    <div class="widget-apis">
                        <div class="api-label">APIs Used:</div>
                        <code>/api/teams/{id}/next-games?count=1</code>
                    </div>
                </div>
            </div>
        </div>

        <!-- API Tester Tab -->
        <div class="tab-content" id="tab-api-tester">
            <!-- Teams API -->
            <div class="api-tester">
                <h3><span class="method">GET</span> Teams API</h3>
                <div class="input-group">
                    <select id="teams-endpoint">
                        <option value="list">List All Teams</option>
                        <option value="by-id">Get Team by ID</option>
                        <option value="by-abbr">Get Team by Abbreviation</option>
                        <option value="next-games">Next Games</option>
                        <option value="last-games">Last Games</option>
                        <option value="standings">Team Standings</option>
                        <option value="conference">Conference Standings</option>
                        <option value="roster">Team Roster</option>
                    </select>
                    <select id="teams-team-select" style="display:none;">
                        <option value="">Select team...</option>
                        {% for team in teams %}
                        <option value="{{ team.id }}" data-abbr="{{ team.abbreviation }}">{{ team.name }} ({{
                            team.abbreviation }})</option>
                        {% endfor %}
                    </select>
                    <input type="text" id="teams-abbr-input" placeholder="e.g. GSW" style="display:none; width:100px;">
                    <select id="teams-conference" style="display:none;">
                        <option value="East">Eastern</option>
                        <option value="West">Western</option>
                    </select>
                    <input type="number" id="teams-count" value="5" min="1" max="20" style="display:none;">
                    <button class="action-btn small" onclick="testTeamsAPI()">
                        <span class="icon">‚ñ∂Ô∏è</span> Run
                    </button>
                </div>
                <div class="api-path">
                    <span class="method-badge">GET</span>
                    <span class="path" id="teams-api-path">/api/teams</span>
                    <button class="copy-btn" onclick="copyPath('teams-api-path')">üìã Copy</button>
                </div>
                <div class="result-container" id="teams-result">
                    <pre></pre>
                </div>
            </div>

            <!-- Players API -->
            <div class="api-tester">
                <h3><span class="method">GET</span> Players API</h3>
                <div class="input-group">
                    <select id="players-endpoint">
                        <option value="search">Search Players</option>
                        <option value="info">Player Info</option>
                        <option value="season-averages">Season Averages</option>
                        <option value="latest-game">Latest Game</option>
                        <option value="roster">Get All Players (Roster)</option>
                    </select>
                    <input type="text" id="players-search" placeholder="Search name (e.g. curry, lebron)..."
                        style="width:220px;">

                    <div id="players-id-container" class="search-container" style="display: none;">
                        <input type="text" id="players-nba-search" placeholder="Search Player..." autocomplete="off">
                        <input type="hidden" id="players-nba-id" placeholder="NBA Player ID (e.g. 201939)">
                        <div id="players-nba-results" class="search-results"></div>
                    </div>
                    <button class="action-btn small" onclick="testPlayersAPI()">
                        <span class="icon">‚ñ∂Ô∏è</span> Run
                    </button>
                </div>
                <div class="api-path">
                    <span class="method-badge">GET</span>
                    <span class="path" id="players-api-path">/api/players/search?name={name}</span>
                    <button class="copy-btn" onclick="copyPath('players-api-path')">üìã Copy</button>
                </div>
                <p id="players-hint" style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">
                    üí° Search for a player to find their NBA ID. Use that ID directly for stats endpoints.
                </p>
                <div class="result-container" id="players-result">
                    <pre></pre>
                </div>
            </div>

            <!-- Games/Boxscore API -->
            <div class="api-tester">
                <h3><span class="method">GET</span> Games & Boxscore API</h3>
                <div class="input-group">
                    <input type="text" id="games-game-id" placeholder="Game ID (e.g. 0022500351)" style="width:220px;">
                    <button class="action-btn small" onclick="testGamesAPI()">
                        <span class="icon">‚ñ∂Ô∏è</span> Run
                    </button>
                </div>
                <div class="api-path">
                    <span class="method-badge">GET</span>
                    <span class="path" id="games-api-path">/api/games/{game_id}/boxscore</span>
                    <button class="copy-btn" onclick="copyPath('games-api-path')">üìã Copy</button>
                </div>
                <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">
                    üí° Returns complete box score with all player stats for a game. Game IDs follow format: 002SSGG###
                    (SS=season, GG=game type)
                </p>
                <div class="result-container" id="games-result">
                    <pre></pre>
                </div>
            </div>

            <!-- Common NBA Player IDs Reference -->
            <div class="api-tester">
                <h3><span class="method">REF</span> Common NBA Player IDs</h3>
                <div
                    style="font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; color: var(--text-secondary); line-height: 1.8;">
                    <div
                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">
                        <span>Stephen Curry: <strong style="color: var(--accent-blue);">201939</strong></span>
                        <span>LeBron James: <strong style="color: var(--accent-blue);">2544</strong></span>
                        <span>Kevin Durant: <strong style="color: var(--accent-blue);">201142</strong></span>
                        <span>Jayson Tatum: <strong style="color: var(--accent-blue);">1628369</strong></span>
                        <span>Luka Donƒçiƒá: <strong style="color: var(--accent-blue);">1629029</strong></span>
                        <span>Giannis: <strong style="color: var(--accent-blue);">203507</strong></span>
                        <span>Nikola Jokiƒá: <strong style="color: var(--accent-blue);">203999</strong></span>
                        <span>Joel Embiid: <strong style="color: var(--accent-blue);">203954</strong></span>
                    </div>
                </div>
                <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.75rem;">
                    üí° Use these IDs directly in your Swift app! Players are auto-created on first request.
                </p>
            </div>
        </div>

        <!-- Data Management Tab (CMS) -->
        <div class="tab-content" id="tab-data-management">
            <!-- Sub-tabs for different data types -->
            <div class="cms-tabs" style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem;">
                <button class="cms-tab active" data-cms="game-stats" onclick="switchCmsTab('game-stats')">üéØ
                    [Player] Latest Game
                    Stats</button>
                <button class="cms-tab" data-cms="games" onclick="switchCmsTab('games')">[Team] Games</button>
                <button class="cms-tab" data-cms="players" onclick="switchCmsTab('players')">[Player] Players
                    DB</button>
                <button class="cms-tab" data-cms="stats" onclick="switchCmsTab('stats')">[Player] Season
                    Average</button>
                <button class="cms-tab" data-cms="standings" onclick="switchCmsTab('standings')">[Team]
                    Standings</button>
            </div>

            <!-- Player Game Stats CMS -->
            <div class="cms-content active" id="cms-game-stats">
                <div class="api-tester">
                    <h3>üéØ Latest Results</h3>
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; align-items: center;">
                        <input type="text" id="game-stats-search-input" placeholder="Search by player name..."
                            style="flex-grow: 1; min-width: 200px;"
                            onkeyup="if(event.key==='Enter') loadCmsGameStats()">
                        <select id="game-stats-filter-team" style="width: 150px;">
                            <option value="">All Teams</option>
                            {% for team in teams %}
                            <option value="{{ team.id }}">{{ team.abbreviation }}</option>
                            {% endfor %}
                        </select>
                        <button class="action-btn small" onclick="loadCmsGameStats()">üîÑ Refresh</button>
                        <button class="action-btn small" onclick="showAddGameStatsForm()">‚ûï Add Game Stats</button>
                    </div>
                    <div id="game-stats-pagination"
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; font-size: 0.875rem; color: var(--text-secondary);">
                        <span id="game-stats-pagination-info">Loading...</span>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="action-btn small" id="game-stats-prev" onclick="loadCmsGameStatsPage(-1)"
                                disabled>‚Üê Prev</button>
                            <button class="action-btn small" id="game-stats-next" onclick="loadCmsGameStatsPage(1)"
                                disabled>Next ‚Üí</button>
                        </div>
                    </div>

                    <!-- Add Game Stats Form -->
                    <div id="add-game-stats-form"
                        style="display: none; background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <h4 style="margin-bottom: 0.75rem; font-size: 0.9rem;">Add Game Stats</h4>
                        <div class="input-group" style="flex-wrap: wrap; gap: 0.5rem;">
                            <input type="number" id="new-game-stats-player-id" placeholder="Player ID"
                                style="width: 100px;">
                            <input type="number" id="new-game-stats-game-id" placeholder="Game ID"
                                style="width: 100px;">
                            <input type="number" id="new-game-stats-pts" placeholder="PTS" style="width: 70px;">
                            <input type="number" id="new-game-stats-reb" placeholder="REB" style="width: 70px;">
                            <input type="number" id="new-game-stats-ast" placeholder="AST" style="width: 70px;">
                            <input type="number" id="new-game-stats-stl" placeholder="STL" style="width: 70px;">
                            <input type="number" id="new-game-stats-blk" placeholder="BLK" style="width: 70px;">
                            <input type="text" id="new-game-stats-minutes" placeholder="MIN (e.g., 34:22)"
                                style="width: 100px;">
                            <button class="action-btn small" onclick="addGameStats()">üíæ Save</button>
                            <button class="action-btn small" onclick="hideAddGameStatsForm()"
                                style="background: var(--bg-hover);">Cancel</button>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="cms-table" id="game-stats-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Player</th>
                                    <th>Game</th>
                                    <th>PTS</th>
                                    <th>REB</th>
                                    <th>AST</th>
                                    <th>STL</th>
                                    <th>BLK</th>
                                    <th>MIN</th>
                                    <th>Last Sync</th>
                                    <th class="actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="game-stats-tbody">
                                <tr>
                                    <td colspan="11" style="text-align: center; color: var(--text-muted);">Loading...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Games CMS -->
            <div class="cms-content" id="cms-games">
                <div class="api-tester">
                    <h3>[Team] Games</h3>
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; align-items: center;">
                        <select id="games-filter-team" style="width: 150px;">
                            <option value="">All Teams</option>
                            {% for team in teams %}
                            <option value="{{ team.id }}">{{ team.abbreviation }}</option>
                            {% endfor %}
                        </select>
                        <select id="games-filter-status" style="width: 120px;">
                            <option value="">All Status</option>
                            <option value="scheduled">Scheduled</option>
                            <option value="live">Live</option>
                            <option value="final">Final</option>
                        </select>
                        <button class="action-btn small" onclick="loadCmsGames()">üîÑ Refresh</button>
                        <button class="action-btn small" onclick="showAddGameForm()">‚ûï Add Game</button>
                    </div>
                    <div id="games-pagination"
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; font-size: 0.875rem; color: var(--text-secondary);">
                        <span id="games-pagination-info">Loading...</span>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="action-btn small" id="games-prev" onclick="loadCmsGamesPage(-1)" disabled>‚Üê
                                Prev</button>
                            <button class="action-btn small" id="games-next" onclick="loadCmsGamesPage(1)" disabled>Next
                                ‚Üí</button>
                        </div>
                    </div>

                    <!-- Add Game Form -->
                    <div id="add-game-form"
                        style="display: none; background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <h4 style="margin-bottom: 0.75rem; font-size: 0.9rem;">Add Game</h4>
                        <div class="input-group" style="flex-wrap: wrap; gap: 0.5rem;">
                            <input type="text" id="new-game-nba-game-id" placeholder="NBA Game ID"
                                style="width: 150px;">
                            <input type="number" id="new-game-home-team-id" placeholder="Home Team ID"
                                style="width: 120px;">
                            <input type="number" id="new-game-away-team-id" placeholder="Away Team ID"
                                style="width: 120px;">
                            <input type="datetime-local" id="new-game-start-time" placeholder="Start Time"
                                style="width: 200px;">
                            <input type="text" id="new-game-status" placeholder="Status (scheduled/live/final)"
                                style="width: 120px;">
                            <input type="number" id="new-game-home-score" placeholder="Home Score"
                                style="width: 100px;">
                            <input type="number" id="new-game-away-score" placeholder="Away Score"
                                style="width: 100px;">
                            <button class="action-btn small" onclick="addGame()">üíæ Save</button>
                            <button class="action-btn small" onclick="hideAddGameForm()"
                                style="background: var(--bg-hover);">Cancel</button>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="cms-table" id="games-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>NBA Game ID</th>
                                    <th>Home</th>
                                    <th>Away</th>
                                    <th>Start Time</th>
                                    <th>Status</th>
                                    <th>Score</th>
                                    <th>Last Sync</th>
                                    <th class="actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="games-tbody">
                                <tr>
                                    <td colspan="9" style="text-align: center; color: var(--text-muted);">Loading...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Players CMS -->
            <div class="cms-content" id="cms-players">
                <div class="api-tester">
                    <h3>[Players] Players DB</h3>
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; align-items: center;">
                        <input type="text" id="players-search-input" placeholder="Search by name..."
                            style="flex-grow: 1; min-width: 200px;" onkeyup="if(event.key==='Enter') loadCmsPlayers()">
                        <select id="players-filter-team" style="width: 150px;">
                            <option value="">All Teams</option>
                            {% for team in teams %}
                            <option value="{{ team.id }}">{{ team.abbreviation }}</option>
                            {% endfor %}
                        </select>
                        <button class="action-btn small" onclick="loadCmsPlayers()">üîÑ Refresh</button>
                        <button class="action-btn small" onclick="showAddPlayerForm()">‚ûï Add Player</button>
                    </div>
                    <div id="players-pagination"
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; font-size: 0.875rem; color: var(--text-secondary);">
                        <span id="players-pagination-info">Loading...</span>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="action-btn small" id="players-prev" onclick="loadCmsPlayersPage(-1)"
                                disabled>‚Üê Prev</button>
                            <button class="action-btn small" id="players-next" onclick="loadCmsPlayersPage(1)"
                                disabled>Next ‚Üí</button>
                        </div>
                    </div>

                    <!-- Add Player Form (hidden by default) -->
                    <div id="add-player-form"
                        style="display: none; background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <h4 style="margin-bottom: 0.75rem; font-size: 0.9rem;">Add New Player</h4>
                        <div class="input-group" style="flex-wrap: wrap; gap: 0.5rem;">
                            <input type="number" id="new-player-nba-id" placeholder="NBA ID" style="width: 100px;">
                            <input type="text" id="new-player-name" placeholder="Full Name" style="width: 180px;">
                            <select id="new-player-team" style="width: 150px;">
                                <option value="">Team (optional)</option>
                                {% for team in teams %}
                                <option value="{{ team.id }}">{{ team.abbreviation }}</option>
                                {% endfor %}
                            </select>
                            <input type="text" id="new-player-position" placeholder="Position" style="width: 80px;">
                            <input type="text" id="new-player-jersey" placeholder="#" style="width: 50px;">
                            <button class="action-btn small" onclick="addPlayer()">üíæ Save</button>
                            <button class="action-btn small" onclick="hideAddPlayerForm()"
                                style="background: var(--bg-hover);">Cancel</button>
                        </div>
                    </div>

                    <div class="cms-table-container">
                        <table class="cms-table" id="players-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>NBA ID</th>
                                    <th>Name</th>
                                    <th>Team</th>
                                    <th>Pos</th>
                                    <th>#</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="players-tbody">
                                <tr>
                                    <td colspan="7" style="text-align: center; color: var(--text-muted);">Loading...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Stats CMS -->
            <div class="cms-content" id="cms-stats">
                <div class="api-tester">
                    <h3>[Player] Season Average</h3>
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; align-items: center;">
                        <input type="text" id="stats-search-input" placeholder="Search by name..."
                            style="flex-grow: 1; min-width: 200px;" onkeyup="if(event.key==='Enter') loadCmsStats()">
                        <select id="stats-filter-team" style="width: 150px;">
                            <option value="">All Teams</option>
                            {% for team in teams %}
                            <option value="{{ team.id }}">{{ team.abbreviation }}</option>
                            {% endfor %}
                        </select>
                        <button class="action-btn small" onclick="loadCmsStats()">üîÑ Refresh</button>
                        <button class="action-btn small" onclick="showAddStatsForm()">‚ûï Add Stats</button>
                    </div>
                    <div id="stats-pagination"
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; font-size: 0.875rem; color: var(--text-secondary);">
                        <span id="stats-pagination-info">Loading...</span>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="action-btn small" id="stats-prev" onclick="loadCmsStatsPage(-1)" disabled>‚Üê
                                Prev</button>
                            <button class="action-btn small" id="stats-next" onclick="loadCmsStatsPage(1)" disabled>Next
                                ‚Üí</button>
                        </div>
                    </div>

                    <!-- Add Stats Form -->
                    <div id="add-stats-form"
                        style="display: none; background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <h4 style="margin-bottom: 0.75rem; font-size: 0.9rem;">Add Season Stats</h4>
                        <div class="input-group" style="flex-wrap: wrap; gap: 0.5rem;">
                            <input type="number" id="new-stats-player-id" placeholder="Player ID" style="width: 100px;">
                            <input type="text" id="new-stats-season" placeholder="Season"
                                value="{{ settings.current_season }}" style="width: 100px;">
                            <input type="number" step="0.1" id="new-stats-pts" placeholder="PPG" style="width: 70px;">
                            <input type="number" step="0.1" id="new-stats-reb" placeholder="RPG" style="width: 70px;">
                            <input type="number" step="0.1" id="new-stats-ast" placeholder="APG" style="width: 70px;">
                            <input type="number" step="0.1" id="new-stats-stl" placeholder="SPG" style="width: 70px;">
                            <input type="number" step="0.1" id="new-stats-blk" placeholder="BPG" style="width: 70px;">
                            <input type="number" id="new-stats-gp" placeholder="GP" style="width: 60px;">
                            <button class="action-btn small" onclick="addStats()">üíæ Save</button>
                            <button class="action-btn small" onclick="hideAddStatsForm()"
                                style="background: var(--bg-hover);">Cancel</button>
                        </div>
                    </div>

                    <div class="cms-table-container">
                        <table class="cms-table" id="stats-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Player</th>
                                    <th>Season</th>
                                    <th>PPG</th>
                                    <th>RPG</th>
                                    <th>APG</th>
                                    <th>GP</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="stats-tbody">
                                <tr>
                                    <td colspan="8" style="text-align: center; color: var(--text-muted);">Loading...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Games CMS -->
            <div class="cms-content" id="cms-games">
                <div class="api-tester">
                    <h3>[Team] Games</h3>
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; align-items: center;">
                        <select id="games-filter-team" style="width: 150px;">
                            <option value="">All Teams</option>
                            {% for team in teams %}
                            <option value="{{ team.id }}">{{ team.abbreviation }}</option>
                            {% endfor %}
                        </select>
                        <select id="games-filter-status" style="width: 120px;">
                            <option value="">All Status</option>
                            <option value="scheduled">Scheduled</option>
                            <option value="final">Final</option>
                        </select>
                        <button class="action-btn small" onclick="loadCmsGames()">üîÑ Refresh</button>
                        <button class="action-btn small" onclick="showAddGameForm()">‚ûï Add Game</button>
                    </div>
                    <div id="games-pagination"
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; font-size: 0.875rem; color: var(--text-secondary);">
                        <span id="games-pagination-info">Loading...</span>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="action-btn small" id="games-prev" onclick="loadCmsGamesPage(-1)" disabled>‚Üê
                                Prev</button>
                            <button class="action-btn small" id="games-next" onclick="loadCmsGamesPage(1)" disabled>Next
                                ‚Üí</button>
                        </div>
                    </div>

                    <!-- Add Game Form -->
                    <div id="add-game-form"
                        style="display: none; background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <h4 style="margin-bottom: 0.75rem; font-size: 0.9rem;">Add New Game</h4>
                        <div class="input-group" style="flex-wrap: wrap; gap: 0.5rem;">
                            <select id="new-game-home" style="width: 130px;">
                                <option value="">Home Team</option>
                                {% for team in teams %}
                                <option value="{{ team.id }}">{{ team.abbreviation }}</option>
                                {% endfor %}
                            </select>
                            <select id="new-game-away" style="width: 130px;">
                                <option value="">Away Team</option>
                                {% for team in teams %}
                                <option value="{{ team.id }}">{{ team.abbreviation }}</option>
                                {% endfor %}
                            </select>
                            <input type="date" id="new-game-date" style="width: 140px;">
                            <input type="time" id="new-game-time" value="19:30" style="width: 100px;">
                            <input type="text" id="new-game-season" value="{{ settings.current_season }}"
                                style="width: 90px;">
                            <button class="action-btn small" onclick="addGame()">üíæ Save</button>
                            <button class="action-btn small" onclick="hideAddGameForm()"
                                style="background: var(--bg-hover);">Cancel</button>
                        </div>
                    </div>

                    <div class="cms-table-container">
                        <table class="cms-table" id="games-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Matchup</th>
                                    <th>Date</th>
                                    <th>Score</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="games-tbody">
                                <tr>
                                    <td colspan="6" style="text-align: center; color: var(--text-muted);">Loading...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Standings CMS -->
            <div class="cms-content" id="cms-standings">
                <div class="api-tester">
                    <h3>üìà Team Standings</h3>
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                        <button class="action-btn small" onclick="loadCmsStandings()">üîÑ Refresh</button>
                    </div>

                    <div class="cms-table-container">
                        <table class="cms-table" id="standings-table">
                            <thead>
                                <tr>
                                    <th>Team</th>
                                    <th>Wins</th>
                                    <th>Losses</th>
                                    <th>Conf Rank</th>
                                    <th>Streak</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="standings-tbody">
                                <tr>
                                    <td colspan="6" style="text-align: center; color: var(--text-muted);">Loading...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cache & Metrics Tab -->
        <div class="tab-content" id="tab-cache-metrics">
            <div class="api-tester">
                <h3>üìä Cache Metrics</h3>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-top: 1rem;">
                    <div
                        style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 600; color: var(--accent-blue);" id="cache-hits">0
                        </div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">CACHE HITS</div>
                    </div>
                    <div
                        style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 600; color: var(--accent-orange);"
                            id="cache-misses">0</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">CACHE MISSES</div>
                    </div>
                    <div
                        style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 600; color: var(--accent-purple);"
                            id="upstream-calls">0</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">API CALLS</div>
                    </div>
                    <div
                        style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 600; color: var(--accent-green);" id="hit-rate">0%
                        </div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">HIT RATE</div>
                    </div>
                </div>

                <h3 style="margin-top: 2rem;">üßπ Cache Management</h3>
                <div
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                    <button class="action-btn" onclick="purgeCache('*')"
                        style="background: var(--accent-red); border-color: var(--accent-red); color: white; justify-content: center;">
                        <span class="icon">üî•</span> Purge All Cache
                    </button>
                    <button class="action-btn" onclick="purgeCache('team:*')" style="justify-content: center;">
                        <span class="icon">üèÄ</span> Purge All Teams
                    </button>
                    <button class="action-btn" onclick="purgeCache('player:*')" style="justify-content: center;">
                        <span class="icon">üë§</span> Purge All Players
                    </button>
                    <button class="action-btn" onclick="purgeCache('*standings*')" style="justify-content: center;">
                        <span class="icon">üìà</span> Purge Standings
                    </button>
                </div>
                <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 1rem;">
                    üí° One-click shortcuts for common cache clearing tasks.
                </p>
            </div>

            <div class="api-tester">
                <h3>üóÑÔ∏è Database Stats</h3>
                <div class="result-container show" id="db-stats-result">
                    <pre>Loading...</pre>
                </div>
                <button class="action-btn" style="margin-top: 1rem;" onclick="loadDbStats()">
                    <span class="icon">üîÑ</span>
                    <span>Refresh Stats</span>
                </button>
            </div>
        </div>

        <!-- Cron Management Tab -->
        <div class="tab-content" id="tab-cron-management">
            <div class="api-tester">
                <h3>‚è∞ Cron Jobs</h3>
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                    <button class="action-btn small" onclick="loadCronJobs()">üîÑ Refresh</button>
                </div>

                <div class="cms-table-container">
                    <table class="cms-table" id="cron-jobs-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Schedule</th>
                                <th>Status</th>
                                <th>Last Run</th>
                                <th>Next Run</th>
                                <th>Total Runs</th>
                                <th>Success Rate</th>
                                <th class="sticky-actions">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="cron-jobs-tbody">
                            <tr>
                                <td colspan="8" style="text-align: center; color: var(--text-muted);">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Running Job Logs Section -->
                <div class="api-tester" id="running-job-logs" style="display: none; margin-top: 2rem;">
                    <h3>üìã Live Logs - <span id="running-job-name"></span></h3>
                    <div
                        style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 0.875rem;">
                        <div id="running-job-log-content"
                            style="color: var(--text-primary); white-space: pre-wrap; word-wrap: break-word;">
                            Waiting for logs...
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                        <button class="action-btn small" onclick="stopWatchingLogs()">‚ùå Stop Watching</button>
                        <button class="action-btn small" onclick="refreshRunningJobLogs()">üîÑ Refresh</button>
                    </div>
                </div>
            </div>

            <div class="api-tester">
                <h3>üìã Recent Cron Runs</h3>
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; align-items: center;">
                    <select id="cron-runs-filter-job" style="width: 200px;">
                        <option value="">All Jobs</option>
                    </select>
                    <select id="cron-runs-filter-status" style="width: 150px;">
                        <option value="">All Status</option>
                        <option value="success">Success</option>
                        <option value="failed">Failed</option>
                        <option value="running">Running</option>
                    </select>
                    <button class="action-btn small" onclick="loadCronRuns()">üîÑ Refresh</button>
                </div>
                <div id="cron-runs-pagination"
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; font-size: 0.875rem; color: var(--text-secondary);">
                    <span id="cron-runs-pagination-info">Loading...</span>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="action-btn small" id="cron-runs-prev" onclick="loadCronRunsPage(-1)" disabled>‚Üê
                            Prev</button>
                        <button class="action-btn small" id="cron-runs-next" onclick="loadCronRunsPage(1)" disabled>Next
                            ‚Üí</button>
                    </div>
                </div>

                <div class="cms-table-container">
                    <table class="cms-table" id="cron-runs-table">
                        <thead>
                            <tr>
                                <th>Job</th>
                                <th>Trigger</th>
                                <th>Started</th>
                                <th>Duration</th>
                                <th>Status</th>
                                <th>Items Updated</th>
                                <th>Details</th>
                                <th style="min-width: 250px;" class="actions-header">Actions & Error</th>
                            </tr>
                        </thead>
                        <tbody id="cron-runs-tbody">
                            <tr>
                                <td colspan="8" style="text-align: center; color: var(--text-muted); padding: 2rem;">
                                    Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast">
        <span id="toast-message"></span>
    </div>

    <!-- Hidden data for JavaScript -->
    <script id="dashboard-teams-data" type="application/json">
        [
            {% for team in teams %}
            {"id": {{ team.id }}, "name": "{{ team.name }}", "abbr": "{{ team.abbreviation }}"}{% if not loop.last %},{% endif %}
            {% endfor %}
        ]
    </script>

    <script>
        const API_BASE = '/api';

        // Read teams from data attribute to avoid auto-formatting issues with Jinja2 in script tags
        const teamsDataEl = document.getElementById('dashboard-teams-data');
        const DASHBOARD_TEAMS = teamsDataEl ? JSON.parse(teamsDataEl.textContent) : [];
        let ALL_PLAYERS = [];

        // =====================
        // CUSTOM MODAL FUNCTIONS
        // =====================
        let customModalCallback = null;

        function showCustomModal(title, message, confirmText = 'Confirm', isDanger = false) {
            return new Promise((resolve) => {
                const overlay = document.getElementById('customModalOverlay');
                const titleEl = document.getElementById('customModalTitle');
                const messageEl = document.getElementById('customModalMessage');
                const confirmBtn = document.getElementById('customModalConfirm');

                titleEl.textContent = title;
                messageEl.textContent = message;
                confirmBtn.textContent = confirmText;

                // Set danger styling if needed
                if (isDanger) {
                    confirmBtn.classList.add('danger');
                } else {
                    confirmBtn.classList.remove('danger');
                }

                // Store callback
                customModalCallback = resolve;

                // Show modal
                overlay.classList.add('active');

                // Focus confirm button
                setTimeout(() => confirmBtn.focus(), 100);
            });
        }

        function closeCustomModal() {
            const overlay = document.getElementById('customModalOverlay');
            overlay.classList.remove('active');
            if (customModalCallback) {
                customModalCallback(false);
                customModalCallback = null;
            }
        }

        function confirmCustomModal() {
            const overlay = document.getElementById('customModalOverlay');
            overlay.classList.remove('active');
            if (customModalCallback) {
                customModalCallback(true);
                customModalCallback = null;
            }
        }

        // Allow ESC to close modals
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (document.getElementById('customModalOverlay').classList.contains('active')) {
                    closeCustomModal();
                } else if (document.getElementById('triggerCronModalOverlay').classList.contains('active')) {
                    closeTriggerCronModal();
                } else if (document.getElementById('runDetailsModalOverlay').classList.contains('active')) {
                    closeRunDetailsModal();
                }
            }
        });

        // =====================
        // TRIGGER CRON MODAL FUNCTIONS
        // =====================
        let triggerCronModalCallback = null;
        let currentJobId = null;
        let currentJobName = null;

        function showTriggerCronModal(jobId, jobName) {
            return new Promise((resolve) => {
                currentJobId = jobId;
                currentJobName = jobName;
                triggerCronModalCallback = resolve;

                const overlay = document.getElementById('triggerCronModalOverlay');
                const titleEl = document.getElementById('triggerCronModalTitle');
                const messageEl = document.getElementById('triggerCronModalMessage');
                const contentEl = document.getElementById('triggerCronModalContent');

                titleEl.textContent = `‚ñ∂Ô∏è Trigger Cron Job: ${jobName}`;
                messageEl.textContent = `Configure options and confirm to run "${jobName}" immediately in the background.`;

                // Build form content based on job type
                let formHTML = '';

                // Hours back input for update_finished_games
                if (jobName === 'update_finished_games') {
                    formHTML += `
                        <div class="form-group">
                            <label for="hoursBackInput">Hours Back</label>
                            <input type="number" id="hoursBackInput" value="12" min="1" max="168" placeholder="12">
                            <small style="color: var(--text-muted); font-size: 0.85rem;">How many hours back to check for finished games (default: 12)</small>
                        </div>
                    `;
                }

                // Form for update_team_results
                if (jobName === 'update_team_results') {
                    formHTML += `
                        <div class="form-group">
                            <label for="teamIdInput">Select Team</label>
                            <select id="teamIdInput">
                                <option value="">All Teams (Optimized Sync)</option>
                                ${DASHBOARD_TEAMS.map(t => `<option value="${t.id}">${t.name} (${t.abbr})</option>`).join('')}
                            </select>
                            <small style="color: var(--text-muted); font-size: 0.85rem;">Specify a team or sync all teams (optimized league-wide call)</small>
                        </div>
                        <div class="form-group">
                            <label for="limitInput">Game Limit (per team)</label>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <input type="number" id="limitInput" value="5" min="1" max="100" placeholder="5">
                                <label style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.9rem; cursor: pointer;">
                                    <input type="checkbox" id="allGamesCheckbox"> All Season
                                </label>
                            </div>
                            <small style="color: var(--text-muted); font-size: 0.85rem;">How many recent games to update per team</small>
                        </div>
                    `;
                }

                if (jobName === 'bootstrap_database') {
                    formHTML += `
                        <div style="background: rgba(255, 193, 7, 0.1); border-left: 4px solid #ffc107; padding: 0.75rem; margin-bottom: 1rem; border-radius: 4px;">
                            <strong style="color: #ffc107; display: block; margin-bottom: 0.25rem;">‚ö†Ô∏è High Load Job</strong>
                            <p style="margin: 0; font-size: 0.9rem;">This will fetch all teams, full season schedules, and all rosters. This may take 30-60 seconds.</p>
                        </div>
                    `;
                }

                // Force update checkbox (available for all jobs)
                formHTML += `
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="forceUpdateCheckbox">
                            <label for="forceUpdateCheckbox" class="checkbox-label">
                                Force update (skip checks - update all data regardless of last sync time)
                            </label>
                        </div>
                        <small style="color: var(--text-muted); font-size: 0.85rem;">When enabled, will update all data even if it was recently synced</small>
                    </div>
                `;

                contentEl.innerHTML = `<div class="trigger-cron-form">${formHTML}</div>`;

                // Add event listener to disable limit input if all games checked
                const allGamesCheckbox = document.getElementById('allGamesCheckbox');
                const limitInput = document.getElementById('limitInput');
                if (allGamesCheckbox && limitInput) {
                    allGamesCheckbox.addEventListener('change', () => {
                        limitInput.disabled = allGamesCheckbox.checked;
                        if (allGamesCheckbox.checked) limitInput.style.opacity = '0.5';
                        else limitInput.style.opacity = '1';
                    });
                }

                // Show modal
                overlay.classList.add('active');

                // Focus first input
                const firstInput = contentEl.querySelector('input');
                if (firstInput) {
                    setTimeout(() => firstInput.focus(), 100);
                }
            });
        }

        function closeTriggerCronModal() {
            const overlay = document.getElementById('triggerCronModalOverlay');
            overlay.classList.remove('active');
            if (triggerCronModalCallback) {
                triggerCronModalCallback(null);
                triggerCronModalCallback = null;
            }
            currentJobId = null;
            currentJobName = null;
        }

        function confirmTriggerCronModal() {
            const overlay = document.getElementById('triggerCronModalOverlay');
            overlay.classList.remove('active');

            let hoursBack = 12; // Default
            let force = false;
            let teamId = null;
            let limit = null;

            if (currentJobName === 'update_finished_games') {
                const hoursBackInput = document.getElementById('hoursBackInput');
                hoursBack = parseInt(hoursBackInput?.value) || 12;
            }

            if (currentJobName === 'update_team_results') {
                const teamIdInput = document.getElementById('teamIdInput');
                const limitInput = document.getElementById('limitInput');
                const allGamesCheckbox = document.getElementById('allGamesCheckbox');

                if (teamIdInput && teamIdInput.value) teamId = parseInt(teamIdInput.value);

                if (allGamesCheckbox && allGamesCheckbox.checked) {
                    limit = 0; // 0 means "all season" in our backend
                } else if (limitInput) {
                    limit = parseInt(limitInput.value) || 5;
                }
            }

            const forceCheckbox = document.getElementById('forceUpdateCheckbox');
            force = forceCheckbox?.checked || false;

            if (triggerCronModalCallback) {
                triggerCronModalCallback({ hoursBack, force, teamId, limit });
                triggerCronModalCallback = null;
            }
            currentJobId = null;
            currentJobName = null;
        }

        // =====================
        // RUN DETAILS MODAL FUNCTIONS
        // =====================
        async function viewRunDetails(runId) {
            try {
                const data = await apiCall(`/admin/cron/runs/${runId}/logs`);
                const overlay = document.getElementById('runDetailsModalOverlay');
                const titleEl = document.getElementById('runDetailsModalTitle');
                const jsonEl = document.getElementById('runDetailsModalJson');

                titleEl.textContent = `üìã Cron Run Details: ${data.job_name}`;

                // Format the details nicely
                const details = data.details || {};
                const formatted = {
                    "Run Information": {
                        "Job Name": data.job_name,
                        "Status": data.status,
                        "Started At": formatReadableDate(data.started_at),
                        "Completed At": data.completed_at ? formatReadableDate(data.completed_at) : 'N/A',
                        "Duration": data.duration_seconds ? `${data.duration_seconds}s` : 'N/A',
                        "Items Updated": data.items_updated || 0,
                        "Triggered By": data.triggered_by || 'N/A',
                        "Error": data.error_message || 'None'
                    },
                    "Details": details
                };

                jsonEl.textContent = JSON.stringify(formatted, null, 2);
                overlay.classList.add('active');
            } catch (e) {
                showToast('Error loading run details: ' + (e.message || e), 'error');
            }
        }

        function closeRunDetailsModal() {
            const overlay = document.getElementById('runDetailsModalOverlay');
            overlay.classList.remove('active');
        }

        // Tab switching with URL hash routing
        function switchTab(tabName, updateHash = true) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            const tab = document.querySelector(`.tab[data-tab="${tabName}"]`);
            const tabContent = document.getElementById('tab-' + tabName);

            if (tab && tabContent) {
                tab.classList.add('active');
                tabContent.classList.add('active');

                // Update URL hash
                if (updateHash) {
                    // If we're on data-management tab, preserve the CMS sub-tab
                    if (tabName === 'data-management') {
                        const activeCmsTab = document.querySelector('.cms-tab.active')?.dataset.cms;
                        if (activeCmsTab) {
                            window.location.hash = `${tabName}/${activeCmsTab}`;
                        } else {
                            window.location.hash = tabName;
                        }
                    } else {
                        window.location.hash = tabName;
                    }
                }

                // Auto-load data for specific tabs
                if (tabName === 'cron-management') {
                    loadCronJobs();
                    loadCronRuns();
                }
            }
        }

        // CMS tab switching with URL hash routing
        function switchCmsTab(cmsName, updateHash = true) {
            document.querySelectorAll('.cms-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.cms-content').forEach(c => c.classList.remove('active'));

            const tab = document.querySelector(`.cms-tab[data-cms="${cmsName}"]`);
            const content = document.getElementById('cms-' + cmsName);

            if (tab && content) {
                tab.classList.add('active');
                content.classList.add('active');

                // Update URL hash
                if (updateHash) {
                    const mainTab = document.querySelector('.tab.active')?.dataset.tab || 'data-management';
                    window.location.hash = `${mainTab}/${cmsName}`;
                }

                // Load data for the tab
                if (cmsName === 'players') loadCmsPlayers();
                if (cmsName === 'stats') loadCmsStats();
                if (cmsName === 'games') loadCmsGames();
                if (cmsName === 'game-stats') loadCmsGameStats();
                if (cmsName === 'standings') loadCmsStandings();
            }
        }

        // Initialize tabs from URL hash on page load
        function initializeTabsFromHash() {
            const hash = window.location.hash.replace('#', '');
            if (hash) {
                const parts = hash.split('/');
                const mainTab = parts[0];
                const cmsTab = parts[1];

                if (mainTab) {
                    switchTab(mainTab, false);

                    if (cmsTab && mainTab === 'data-management') {
                        setTimeout(() => switchCmsTab(cmsTab, false), 100);
                    }
                }
            }
        }

        // Listen for hash changes
        window.addEventListener('hashchange', initializeTabsFromHash);

        // Initialize on page load
        initializeTabsFromHash();

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                switchTab(tab.dataset.tab);
            });
        });

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            toast.className = `toast ${type} show`;
            toastMessage.textContent = message;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function copyPath(elementId) {
            const path = document.getElementById(elementId).textContent;
            navigator.clipboard.writeText(path);
            showToast('Path copied to clipboard!');
        }

        // =====================
        // WIDGET FUNCTIONS
        // =====================

        // Helper to format date/time in user's local timezone
        function formatLocalDate(dateStr, timeStr) {
            // API returns UTC times - parse as UTC and convert to local
            const utcDateStr = `${dateStr}T${timeStr || '00:00'}:00Z`; // Z indicates UTC
            const date = new Date(utcDateStr); // JavaScript Date parses UTC and converts to local automatically

            return {
                date: date.toLocaleDateString('en-US', { day: 'numeric', month: 'short' }),
                time: date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }),
                weekday: date.toLocaleDateString('en-US', { weekday: 'short' }),
                full: date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }),
                dateObj: date
            };
        }

        function formatLocalDateOnly(dateStr) {
            const date = new Date(dateStr + 'T12:00:00'); // Noon to avoid timezone day shifts
            return date.toLocaleDateString('en-US', { day: 'numeric', month: 'short' });
        }

        // Check if a game is still relevant (in future or started within last 3 hours)
        function isGameStillRelevant(dateStr, timeStr) {
            const local = formatLocalDate(dateStr, timeStr);
            const gameDate = local.dateObj;
            const now = new Date();
            const threeHoursAgo = new Date(now.getTime() - (3 * 60 * 60 * 1000));

            // Game is relevant if it starts after 3 hours ago (future or ongoing)
            return gameDate >= threeHoursAgo;
        }

        // Filter games to only show future/ongoing games
        function filterFutureGames(games) {
            return games.filter(game => isGameStillRelevant(game.date, game.time));
        }

        async function loadAllWidgets() {
            const teamId = document.getElementById('widget-team').value;
            const playerId = document.getElementById('widget-player-id').value;

            loadNextGamesWidget(teamId);
            loadSeasonAvgWidget(playerId);
            loadLastResultsWidget(teamId);
            loadStandingWidget(teamId);
            loadPlayerLastGameWidget(playerId);
            loadCountdownWidget(teamId);
        }

        async function loadNextGamesWidget(teamId) {
            const container = document.querySelector('#widget-next-games .widget-content');
            container.innerHTML = '<div class="loading-spinner"></div> Loading...';

            try {
                const [gamesData, standingData] = await Promise.all([
                    // Fetch more games than needed so we can filter
                    fetch(`${API_BASE}/teams/${teamId}/next-games?count=10`).then(r => r.json()),
                    fetch(`${API_BASE}/teams/${teamId}/standings`).then(r => r.json())
                ]);

                const teamAbbr = document.querySelector('#widget-team option:checked').dataset.abbr;
                const record = `${standingData.wins}-${standingData.losses}`;

                // Filter to only future/ongoing games and take first 3
                const futureGames = filterFutureGames(gamesData.games).slice(0, 3);

                let html = `
                    <div class="team-header">
                        <span class="team-abbr">${teamAbbr}</span>
                        <span class="team-record">(${record})</span>
                    </div>
                `;

                if (futureGames.length === 0) {
                    html += '<div style="color: var(--text-muted); padding: 0.5rem 0;">No upcoming games scheduled</div>';
                } else {
                    for (const game of futureGames) {
                        const local = formatLocalDate(game.date, game.time);
                        const vsAt = game.is_home ? 'vs' : '@';

                        html += `
                            <div class="game-row">
                                <span class="game-vs">${vsAt}</span>
                                <span class="game-opponent">${game.opponent}</span>
                                <span class="game-datetime">${local.date} ${local.time}</span>
                            </div>
                        `;
                    }
                }

                container.innerHTML = html;
            } catch (e) {
                container.innerHTML = `<span style="color: var(--accent-red);">Error: ${e.message}</span>`;
            }
        }

        async function loadSeasonAvgWidget(playerId) {
            const container = document.querySelector('#widget-season-avg .widget-content');
            container.innerHTML = '<div class="loading-spinner"></div> Loading...';

            try {
                const data = await fetch(`${API_BASE}/players/${playerId}/season-averages`).then(r => r.json());

                container.innerHTML = `
                    <div class="player-header">
                        <span class="player-name">${data.player_name}</span>
                        <span class="player-number">30</span>
                    </div>
                    <div class="stats-row">
                        <div class="stat"><span class="stat-value">${data.ppg}</span><span class="stat-label">ppg</span></div>
                        <div class="stat"><span class="stat-value">${data.apg}</span><span class="stat-label">apg</span></div>
                        <div class="stat"><span class="stat-value">${data.rpg}</span><span class="stat-label">rpg</span></div>
                        <div class="stat"><span class="stat-value">${data.bpg}</span><span class="stat-label">bpg</span></div>
                        <div class="stat"><span class="stat-value">${data.spg}</span><span class="stat-label">spg</span></div>
                        <div class="stat"><span class="stat-value">${data.fg_pct}%</span><span class="stat-label">fg</span></div>
                        <div class="stat"><span class="stat-value">${data.fg3_pct}%</span><span class="stat-label">3fg</span></div>
                        <div class="stat"><span class="stat-value">${data.ft_pct}%</span><span class="stat-label">ft</span></div>
                    </div>
                `;
            } catch (e) {
                container.innerHTML = `<span style="color: var(--accent-red);">Error: ${e.message}</span>`;
            }
        }

        async function loadLastResultsWidget(teamId) {
            const container = document.querySelector('#widget-last-results .widget-content');
            container.innerHTML = '<div class="loading-spinner"></div> Loading...';

            try {
                const data = await fetch(`${API_BASE}/teams/${teamId}/last-games?count=3`).then(r => r.json());
                const teamAbbr = document.querySelector('#widget-team option:checked').dataset.abbr;

                let html = '';
                for (const game of data.games) {
                    const dateStr = formatLocalDateOnly(game.date);
                    const isWin = game.result === 'W';
                    const scoreClass = isWin ? 'win' : 'loss';

                    html += `
                        <div class="result-row">
                            <span class="result-teams">${teamAbbr} vs ${game.opponent}</span>
                            <span class="result-score ${scoreClass}">${game.team_score} - ${game.opponent_score}</span>
                            <span class="result-date">${dateStr}</span>
                        </div>
                    `;
                }

                container.innerHTML = html;
            } catch (e) {
                container.innerHTML = `<span style="color: var(--accent-red);">Error: ${e.message}</span>`;
            }
        }

        async function loadStandingWidget(teamId) {
            const container = document.querySelector('#widget-standing .widget-content');
            container.innerHTML = '<div class="loading-spinner"></div> Loading...';

            try {
                const data = await fetch(`${API_BASE}/teams/${teamId}/standings`).then(r => r.json());
                const teamAbbr = document.querySelector('#widget-team option:checked').dataset.abbr;

                container.innerHTML = `
                    <div class="team-name">${teamAbbr}</div>
                    <div class="standing-info">
                        <span class="record">${data.wins}-${data.losses}</span>
                        <span class="rank">${data.conference_rank_display} in ${data.conference}</span>
                    </div>
                `;
            } catch (e) {
                container.innerHTML = `<span style="color: var(--accent-red);">Error: ${e.message}</span>`;
            }
        }

        async function loadPlayerLastGameWidget(playerId) {
            const container = document.querySelector('#widget-player-last .widget-content');
            container.innerHTML = '<div class="loading-spinner"></div> Loading...';

            try {
                const data = await fetch(`${API_BASE}/players/${playerId}/latest-game`).then(r => r.json());

                container.innerHTML = `
                    <div class="player-header">
                        <span class="player-name">${data.player_name}</span>
                        <span class="player-number">30</span>
                    </div>
                    <div class="stats-line">
                        <span class="stat-value">${data.pts}</span>pt 
                        <span class="stat-value">${data.reb}</span>rb 
                        <span class="stat-value">${data.ast}</span>as 
                        vs ${data.opponent}
                    </div>
                    <div class="game-result">
                        ${data.game_date}
                    </div>
                `;
            } catch (e) {
                container.innerHTML = `<span style="color: var(--accent-red);">Error: ${e.message}</span>`;
            }
        }

        async function loadCountdownWidget(teamId) {
            const container = document.querySelector('#widget-countdown .widget-content');
            container.innerHTML = '<div class="loading-spinner"></div> Loading...';

            try {
                // Fetch more games to filter
                const data = await fetch(`${API_BASE}/teams/${teamId}/next-games?count=5`).then(r => r.json());
                const teamAbbr = document.querySelector('#widget-team option:checked').dataset.abbr;

                // Filter to only future/ongoing games
                const futureGames = filterFutureGames(data.games);

                if (futureGames.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: var(--text-muted);">No upcoming games</div>';
                    return;
                }

                const game = futureGames[0];
                const local = formatLocalDate(game.date, game.time);
                const gameDate = local.dateObj;
                const now = new Date();
                const diff = gameDate - now;

                // Check if game is currently in progress (started but within 3 hours)
                const isInProgress = diff < 0 && diff > -(3 * 60 * 60 * 1000);

                const days = Math.max(0, Math.floor(diff / (1000 * 60 * 60 * 24)));
                const hours = Math.max(0, Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)));
                const mins = Math.max(0, Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60)));

                const matchup = game.is_home ? `${game.opponent} vs ${teamAbbr}` : `${teamAbbr} @ ${game.opponent}`;

                if (isInProgress) {
                    container.innerHTML = `
                        <div class="matchup">${matchup}</div>
                        <div class="countdown-display">
                            <div class="countdown-item">
                                <div class="countdown-value" style="color: var(--accent-green);">LIVE</div>
                                <div class="countdown-label">In Progress</div>
                            </div>
                        </div>
                        <div class="game-datetime">Started at ${local.time}</div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="matchup">${matchup}</div>
                        <div class="countdown-display">
                            <div class="countdown-item">
                                <div class="countdown-value">${days}</div>
                                <div class="countdown-label">Days</div>
                            </div>
                            <div class="countdown-item">
                                <div class="countdown-value">${hours}</div>
                                <div class="countdown-label">Hours</div>
                            </div>
                            <div class="countdown-item">
                                <div class="countdown-value">${mins}</div>
                                <div class="countdown-label">Mins</div>
                            </div>
                        </div>
                        <div class="game-datetime">${local.full} at ${local.time}</div>
                    `;
                }
            } catch (e) {
                container.innerHTML = `<span style="color: var(--accent-red);">Error: ${e.message}</span>`;
            }
        }

        async function purgeCache(pattern = '*') {
            const confirmed = await showCustomModal(
                'üî• Purge Cache',
                `Are you sure you want to purge cache for: "${pattern}"?`,
                'Purge Now',
                true
            );

            if (!confirmed) return;

            try {
                const data = await apiCall(`/admin/cache/clear?pattern=${encodeURIComponent(pattern)}`, 'POST');
                showToast(`Success! Purged ${data.keys_deleted} keys.`);
                updateMetrics();
            } catch (e) {
                showToast('Failed to purge cache: ' + (e.detail || e.message || 'Unknown error'), 'error');
            }
        }

        // =====================
        // API TESTER FUNCTIONS
        // =====================

        function updateTeamsApiPath() {
            const endpoint = document.getElementById('teams-endpoint').value;
            const teamId = document.getElementById('teams-team-select').value || '{team_id}';
            const abbr = document.getElementById('teams-abbr-input').value || '{abbr}';
            const conference = document.getElementById('teams-conference').value;
            const count = document.getElementById('teams-count').value;

            let path = '/api/teams';
            switch (endpoint) {
                case 'list': path = '/api/teams'; break;
                case 'by-id': path = `/api/teams/${teamId}`; break;
                case 'by-abbr': path = `/api/teams/abbr/${abbr.toUpperCase() || '{ABBR}'}`; break;
                case 'next-games': path = `/api/teams/${teamId}/next-games?count=${count}`; break;
                case 'last-games': path = `/api/teams/${teamId}/last-games?count=${count}`; break;
                case 'standings': path = `/api/teams/${teamId}/standings`; break;
                case 'conference': path = `/api/teams/standings/${conference}`; break;
                case 'roster': path = `/api/teams/${teamId}/roster`; break;
            }
            document.getElementById('teams-api-path').textContent = path;
        }

        function updatePlayersApiPath() {
            const endpoint = document.getElementById('players-endpoint').value;
            const searchName = document.getElementById('players-search').value || '{name}';
            const nbaId = document.getElementById('players-nba-id').value || '{nba_player_id}';

            let path = '/api/players/search?name={name}';
            switch (endpoint) {
                case 'search': path = `/api/players/search?name=${encodeURIComponent(searchName)}`; break;
                case 'info': path = `/api/players/${nbaId}/info`; break;
                case 'season-averages': path = `/api/players/${nbaId}/season-averages`; break;
                case 'latest-game': path = `/api/players/${nbaId}/latest-game`; break;
                case 'roster': path = `/api/players/roster`; break;
            }
            document.getElementById('players-api-path').textContent = path;
        }

        // =====================
        // PLAYER SEARCH LOGIC
        // =====================

        async function initPlayerSearch() {
            try {
                const response = await fetch(`${API_BASE}/players/roster`);
                const data = await response.json();
                if (data.players && data.players.length > 0) {
                    ALL_PLAYERS = data.players;
                    console.log('Roster loaded:', ALL_PLAYERS.length, 'players');
                } else {
                    console.warn('Roster loaded but empty');
                    showToast('‚ö†Ô∏è Player database is empty. Please run "bootstrap_database" in Cron Management tab.', 'warning');
                }

                // Initialize search widgets (even if empty, to setup listeners)
                setupPlayerSearch('widget-player-search', 'widget-player-id', 'widget-player-results');
                setupPlayerSearch('players-nba-search', 'players-nba-id', 'players-nba-results');

                // Pre-fill widget search input if ID exists and we have data
                if (ALL_PLAYERS.length > 0) {
                    const widgetId = document.getElementById('widget-player-id').value;
                    if (widgetId) {
                        const player = ALL_PLAYERS.find(p => p.nba_player_id == widgetId);
                        if (player) {
                            document.getElementById('widget-player-search').value = player.name;
                        }
                    }
                }
            } catch (e) {
                console.error('Failed to load roster:', e);
                showToast('Failed to load player roster', 'error');
            }
        }

        function setupPlayerSearch(searchInputId, hiddenInputId, resultsId) {
            const searchInput = document.getElementById(searchInputId);
            const hiddenInput = document.getElementById(hiddenInputId);
            const results = document.getElementById(resultsId);

            if (!searchInput || !hiddenInput || !results) return;

            // Hide results on click outside
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !results.contains(e.target)) {
                    results.classList.remove('show');
                }
            });

            // Search handler
            searchInput.addEventListener('input', () => {
                const query = searchInput.value.toLowerCase().trim();

                if (query.length < 2) {
                    results.classList.remove('show');
                    return;
                }

                // Fuzzy search logic
                const matches = ALL_PLAYERS.filter(p => {
                    const name = p.name.toLowerCase();
                    // Direct match
                    if (name.includes(query)) return true;
                    // Initial match (e.g. "sc" for "Stephen Curry")
                    const parts = name.split(' ');
                    if (parts.length > 1 && parts[0].startsWith(query[0]) && parts[1].startsWith(query[1])) return true;
                    return false;
                }).slice(0, 10); // Limit to 10 results

                if (matches.length > 0) {
                    results.innerHTML = matches.map(p => `
                        <div class="search-result-item" onclick="selectPlayer('${p.nba_player_id}', '${p.name.replace(/'/g, "\\'")}', '${searchInputId}', '${hiddenInputId}', '${resultsId}')">
                            <span class="player-name">${p.name}</span>
                            <span class="player-team">${p.team_abbreviation}</span>
                        </div>
                    `).join('');
                    results.classList.add('show');
                } else {
                    results.classList.remove('show');
                }
            });

            // Show results on focus if input has value
            searchInput.addEventListener('focus', () => {
                if (searchInput.value.length >= 2) {
                    searchInput.dispatchEvent(new Event('input'));
                }
            });
        }

        function selectPlayer(id, name, searchInputId, hiddenInputId, resultsId) {
            document.getElementById(searchInputId).value = name;
            document.getElementById(hiddenInputId).value = id;
            document.getElementById(resultsId).classList.remove('show');

            // Trigger change event/update path
            if (hiddenInputId === 'players-nba-id') {
                updatePlayersApiPath();
            }
        }

        document.getElementById('teams-endpoint').addEventListener('change', function () {
            const teamSelect = document.getElementById('teams-team-select');
            const abbrInput = document.getElementById('teams-abbr-input');
            const conferenceSelect = document.getElementById('teams-conference');
            const countInput = document.getElementById('teams-count');

            teamSelect.style.display = 'none';
            abbrInput.style.display = 'none';
            conferenceSelect.style.display = 'none';
            countInput.style.display = 'none';

            switch (this.value) {
                case 'by-id':
                case 'next-games':
                case 'last-games':
                case 'standings':
                case 'roster':
                    teamSelect.style.display = 'block';
                    if (this.value === 'next-games' || this.value === 'last-games') {
                        countInput.style.display = 'block';
                    }
                    break;
                case 'by-abbr':
                    abbrInput.style.display = 'block';
                    break;
                case 'conference':
                    conferenceSelect.style.display = 'block';
                    break;
            }
            updateTeamsApiPath();
        });

        document.getElementById('teams-team-select').addEventListener('change', updateTeamsApiPath);
        document.getElementById('teams-abbr-input').addEventListener('input', updateTeamsApiPath);
        document.getElementById('teams-conference').addEventListener('change', updateTeamsApiPath);
        document.getElementById('teams-count').addEventListener('input', updateTeamsApiPath);

        document.getElementById('players-endpoint').addEventListener('change', function () {
            const searchInput = document.getElementById('players-search');
            const idContainer = document.getElementById('players-id-container');
            const hint = document.getElementById('players-hint');

            searchInput.style.display = 'none';
            idContainer.style.display = 'none';

            switch (this.value) {
                case 'search':
                    searchInput.style.display = 'block';
                    hint.textContent = 'üí° Search for a player to find their NBA ID.';
                    break;
                case 'info':
                case 'season-averages':
                case 'latest-game':
                    idContainer.style.display = 'inline-block';
                    hint.textContent = 'üí° Search for a player above.';
                    break;
                case 'roster':
                    hint.textContent = 'üí° Returns complete list of all players.';
                    break;
            }
            updatePlayersApiPath();
        });

        document.getElementById('players-search').addEventListener('input', updatePlayersApiPath);
        // players-nba-id update is handled by selectPlayer function

        function showResult(containerId, data, isError = false) {
            const container = document.getElementById(containerId);
            const pre = container.querySelector('pre');
            container.classList.add('show');

            if (isError) {
                pre.innerHTML = `<span class="error">${JSON.stringify(data, null, 2)}</span>`;
            } else {
                pre.textContent = JSON.stringify(data, null, 2);
            }
        }

        function showLoading(containerId) {
            const container = document.getElementById(containerId);
            const pre = container.querySelector('pre');
            container.classList.add('show');
            pre.innerHTML = '<span class="loading">Loading...</span>';
        }

        async function apiCall(endpoint, method = 'GET') {
            const response = await fetch(`${API_BASE}${endpoint}`, { method });
            const data = await response.json();
            if (!response.ok) throw { status: response.status, ...data };
            return data;
        }

        async function testTeamsAPI() {
            const endpoint = document.getElementById('teams-endpoint').value;
            const teamId = document.getElementById('teams-team-select').value;
            const abbr = document.getElementById('teams-abbr-input').value;
            const conference = document.getElementById('teams-conference').value;
            const count = document.getElementById('teams-count').value;

            showLoading('teams-result');

            try {
                let url;
                switch (endpoint) {
                    case 'list': url = '/teams'; break;
                    case 'by-id':
                        if (!teamId) throw { detail: 'Please select a team' };
                        url = `/teams/${teamId}`; break;
                    case 'by-abbr':
                        if (!abbr) throw { detail: 'Please enter abbreviation' };
                        url = `/teams/abbr/${abbr.toUpperCase()}`; break;
                    case 'next-games':
                        if (!teamId) throw { detail: 'Please select a team' };
                        url = `/teams/${teamId}/next-games?count=${count}`; break;
                    case 'last-games':
                        if (!teamId) throw { detail: 'Please select a team' };
                        url = `/teams/${teamId}/last-games?count=${count}`; break;
                    case 'standings':
                        if (!teamId) throw { detail: 'Please select a team' };
                        url = `/teams/${teamId}/standings`; break;
                    case 'conference':
                        url = `/teams/standings/${conference}`; break;
                    case 'roster':
                        if (!teamId) throw { detail: 'Please select a team' };
                        url = `/teams/${teamId}/roster`; break;
                }

                const data = await apiCall(url);
                showResult('teams-result', data);
            } catch (e) {
                showResult('teams-result', e, true);
            }
        }

        async function testPlayersAPI() {
            const endpoint = document.getElementById('players-endpoint').value;
            const searchName = document.getElementById('players-search').value;
            const nbaPlayerId = document.getElementById('players-nba-id').value;

            showLoading('players-result');

            try {
                let url;
                switch (endpoint) {
                    case 'search':
                        if (!searchName || searchName.length < 2) throw { detail: 'Enter at least 2 characters' };
                        url = `/players/search?name=${encodeURIComponent(searchName)}`; break;
                    case 'info':
                        if (!nbaPlayerId) throw { detail: 'Please enter NBA Player ID' };
                        url = `/players/${nbaPlayerId}/info`; break;
                    case 'season-averages':
                        if (!nbaPlayerId) throw { detail: 'Please enter NBA Player ID' };
                        url = `/players/${nbaPlayerId}/season-averages`; break;
                    case 'latest-game':
                        if (!nbaPlayerId) throw { detail: 'Please enter NBA Player ID' };
                        url = `/players/${nbaPlayerId}/latest-game`; break;
                    case 'roster':
                        url = `/players/roster`; break;
                }

                const data = await apiCall(url);
                showResult('players-result', data);
            } catch (e) {
                showResult('players-result', e, true);
            }
        }

        async function testGamesAPI() {
            const gameId = document.getElementById('games-game-id').value;

            showLoading('games-result');

            try {
                if (!gameId || gameId.length < 10) {
                    throw { detail: 'Please enter a valid Game ID (e.g. 0022500351)' };
                }

                const url = `/games/${gameId}/boxscore`;
                document.getElementById('games-api-path').textContent = `/api${url}`;

                const data = await apiCall(url);
                showResult('games-result', data);
            } catch (e) {
                showResult('games-result', e, true);
            }
        }

        async function updateMetrics() {
            try {
                const data = await fetch(`${API_BASE}/admin/metrics`).then(r => r.json());
                document.getElementById('cache-hits').textContent = data.cache.hits;
                document.getElementById('cache-misses').textContent = data.cache.misses;
                document.getElementById('upstream-calls').textContent = data.cache.upstream_calls;
                document.getElementById('hit-rate').textContent = data.cache.hit_rate_pct + '%';
            } catch (e) {
                console.error('Failed to update metrics:', e);
            }
        }

        async function loadDbStats() {
            try {
                const data = await apiCall('/admin/stats');
                showResult('db-stats-result', data);
            } catch (e) {
                showResult('db-stats-result', e, true);
            }
        }

        // =====================
        // CMS FUNCTIONS
        // =====================

        // Pagination state
        const cmsPagination = {
            players: { offset: 0, limit: 100, total: 0 },
            stats: { offset: 0, limit: 100, total: 0 },
            games: { offset: 0, limit: 100, total: 0 },
            gameStats: { offset: 0, limit: 100, total: 0 },
        };


        // Show/hide forms
        function showAddPlayerForm() { document.getElementById('add-player-form').style.display = 'block'; }
        function hideAddPlayerForm() { document.getElementById('add-player-form').style.display = 'none'; }
        function showAddStatsForm() { document.getElementById('add-stats-form').style.display = 'block'; }
        function hideAddStatsForm() { document.getElementById('add-stats-form').style.display = 'none'; }
        function showAddGameForm() { document.getElementById('add-game-form').style.display = 'block'; }
        function hideAddGameForm() { document.getElementById('add-game-form').style.display = 'none'; }

        // PLAYERS
        async function loadCmsPlayers() {
            const tbody = document.getElementById('players-tbody');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-muted);">Loading...</td></tr>';

            const search = document.getElementById('players-search-input').value.trim();
            const teamId = document.getElementById('players-filter-team').value;
            const pag = cmsPagination.players;

            let url = `/admin/data/players?limit=${pag.limit}&offset=${pag.offset}`;
            if (search) url += `&search=${encodeURIComponent(search)}`;
            if (teamId) url += `&team_id=${teamId}`;

            try {
                const data = await apiCall(url);
                pag.total = data.total || 0;

                if (data.players.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-muted);">No players found</td></tr>';
                    updatePaginationUI('players', pag);
                    return;
                }

                tbody.innerHTML = data.players.map(p => `
                    <tr data-id="${p.id}">
                        <td>${p.id}</td>
                        <td>${p.nba_player_id}</td>
                        <td><input type="text" value="${p.full_name || ''}" data-field="full_name"></td>
                        <td>${p.team || '-'}</td>
                        <td><input type="text" value="${p.position || ''}" data-field="position" style="width: 50px;"></td>
                        <td><input type="text" value="${p.jersey_number || ''}" data-field="jersey_number" style="width: 40px;"></td>
                        <td class="actions">
                            <button class="btn-edit" onclick="savePlayer(${p.id})">üíæ</button>
                            <button class="btn-delete" onclick="deletePlayer(${p.id})">üóëÔ∏è</button>
                        </td>
                    </tr>
                `).join('');

                updatePaginationUI('players', pag);
            } catch (e) {
                tbody.innerHTML = `<tr><td colspan="7" style="color: var(--accent-red);">Error: ${e.message || e.detail}</td></tr>`;
            }
        }

        function loadCmsPlayersPage(direction) {
            const pag = cmsPagination.players;
            pag.offset = Math.max(0, pag.offset + (direction * pag.limit));
            loadCmsPlayers();
        }

        function updatePaginationUI(type, pag) {
            const infoEl = document.getElementById(`${type}-pagination-info`);
            const prevBtn = document.getElementById(`${type}-prev`);
            const nextBtn = document.getElementById(`${type}-next`);

            if (infoEl) {
                const start = pag.offset + 1;
                const end = Math.min(pag.offset + pag.limit, pag.total);
                infoEl.textContent = `Showing ${start}-${end} of ${pag.total}`;
            }

            if (prevBtn) prevBtn.disabled = pag.offset === 0;
            if (nextBtn) nextBtn.disabled = pag.offset + pag.limit >= pag.total;
        }

        async function addPlayer() {
            const nbaId = document.getElementById('new-player-nba-id').value;
            const name = document.getElementById('new-player-name').value;
            const teamId = document.getElementById('new-player-team').value;
            const position = document.getElementById('new-player-position').value;
            const jersey = document.getElementById('new-player-jersey').value;

            if (!nbaId || !name) {
                showToast('NBA ID and Name required', 'error');
                return;
            }

            try {
                await fetch(`${API_BASE}/admin/data/players`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        nba_player_id: parseInt(nbaId),
                        full_name: name,
                        team_id: teamId ? parseInt(teamId) : null,
                        position: position || null,
                        jersey_number: jersey || null
                    })
                });
                showToast('Player added!');
                hideAddPlayerForm();
                loadCmsPlayers();
            } catch (e) {
                showToast('Error adding player', 'error');
            }
        }

        async function savePlayer(id) {
            const row = document.querySelector(`tr[data-id="${id}"]`);
            const data = {};
            row.querySelectorAll('input[data-field]').forEach(input => {
                data[input.dataset.field] = input.value || null;
            });

            try {
                await fetch(`${API_BASE}/admin/data/players/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                showToast('Player saved!');
            } catch (e) {
                showToast('Error saving', 'error');
            }
        }

        async function deletePlayer(id) {
            if (!confirm('Delete this player?')) return;
            try {
                await fetch(`${API_BASE}/admin/data/players/${id}`, { method: 'DELETE' });
                showToast('Player deleted');
                loadCmsPlayers();
            } catch (e) {
                showToast('Error deleting', 'error');
            }
        }

        // STATS
        async function loadCmsStats() {
            const tbody = document.getElementById('stats-tbody');
            tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--text-muted);">Loading...</td></tr>';

            const search = document.getElementById('stats-search-input').value.trim();
            const teamId = document.getElementById('stats-filter-team').value;
            const pag = cmsPagination.stats;

            let url = `/admin/data/player-stats?limit=${pag.limit}&offset=${pag.offset}`;
            if (search) url += `&search=${encodeURIComponent(search)}`;
            if (teamId) url += `&team_id=${teamId}`;

            try {
                const data = await apiCall(url);
                pag.total = data.total || 0;

                if (data.stats.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--text-muted);">No stats found</td></tr>';
                    updatePaginationUI('stats', pag);
                    return;
                }

                tbody.innerHTML = data.stats.map(s => `
                    <tr data-id="${s.id}">
                        <td>${s.id}</td>
                        <td>${s.player_name || s.player_id}</td>
                        <td>${s.season}</td>
                        <td><input type="number" step="0.1" value="${s.pts}" data-field="pts" style="width: 60px;"></td>
                        <td><input type="number" step="0.1" value="${s.reb}" data-field="reb" style="width: 60px;"></td>
                        <td><input type="number" step="0.1" value="${s.ast}" data-field="ast" style="width: 60px;"></td>
                        <td><input type="number" value="${s.games_played}" data-field="games_played" style="width: 50px;"></td>
                        <td class="actions">
                            <button class="btn-edit" onclick="saveStats(${s.id})">üíæ</button>
                            <button class="btn-delete" onclick="deleteStats(${s.id})">üóëÔ∏è</button>
                        </td>
                    </tr>
                `).join('');

                updatePaginationUI('stats', pag);
            } catch (e) {
                tbody.innerHTML = `<tr><td colspan="8" style="color: var(--accent-red);">Error: ${e.message || e.detail}</td></tr>`;
            }
        }

        function loadCmsStatsPage(direction) {
            const pag = cmsPagination.stats;
            pag.offset = Math.max(0, pag.offset + (direction * pag.limit));
            loadCmsStats();
        }

        async function addStats() {
            const playerId = document.getElementById('new-stats-player-id').value;
            const season = document.getElementById('new-stats-season').value;

            if (!playerId || !season) {
                showToast('Player ID and Season required', 'error');
                return;
            }

            try {
                await fetch(`${API_BASE}/admin/data/player-stats`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        player_id: parseInt(playerId),
                        season: season,
                        pts: parseFloat(document.getElementById('new-stats-pts').value) || 0,
                        reb: parseFloat(document.getElementById('new-stats-reb').value) || 0,
                        ast: parseFloat(document.getElementById('new-stats-ast').value) || 0,
                        stl: parseFloat(document.getElementById('new-stats-stl').value) || 0,
                        blk: parseFloat(document.getElementById('new-stats-blk').value) || 0,
                        games_played: parseInt(document.getElementById('new-stats-gp').value) || 0
                    })
                });
                showToast('Stats added!');
                hideAddStatsForm();
                loadCmsStats();
            } catch (e) {
                showToast('Error adding stats', 'error');
            }
        }

        async function saveStats(id) {
            const row = document.querySelector(`#stats-table tr[data-id="${id}"]`);
            const data = {};
            row.querySelectorAll('input[data-field]').forEach(input => {
                data[input.dataset.field] = input.type === 'number' ? parseFloat(input.value) : input.value;
            });

            try {
                await fetch(`${API_BASE}/admin/data/player-stats/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                showToast('Stats saved!');
            } catch (e) {
                showToast('Error saving', 'error');
            }
        }

        async function deleteStats(id) {
            if (!confirm('Delete these stats?')) return;
            try {
                await fetch(`${API_BASE}/admin/data/player-stats/${id}`, { method: 'DELETE' });
                showToast('Stats deleted');
                loadCmsStats();
            } catch (e) {
                showToast('Error deleting', 'error');
            }
        }

        // GAMES
        async function loadCmsGames() {
            const tbody = document.getElementById('games-tbody');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-muted);">Loading...</td></tr>';

            const teamId = document.getElementById('games-filter-team').value;
            const status = document.getElementById('games-filter-status').value;
            const pag = cmsPagination.games;

            let url = `/admin/data/games?limit=${pag.limit}&offset=${pag.offset}`;
            if (teamId) url += `&team_id=${teamId}`;
            if (status) url += `&status=${status}`;

            try {
                const data = await apiCall(url);
                pag.total = data.total || 0;

                if (data.games.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-muted);">No games found</td></tr>';
                    updatePaginationUI('games', pag);
                    return;
                }

                tbody.innerHTML = data.games.map(g => `
                    <tr data-id="${g.id}">
                        <td data-label="ID">${g.id}</td>
                        <td data-label="Matchup">${g.away_team} @ ${g.home_team}</td>
                        <td data-label="Date">${g.game_date || '-'}</td>
                        <td data-label="Score">
                            <input type="number" value="${g.home_score || ''}" data-field="home_score" style="width: 50px;" placeholder="H">
                            -
                            <input type="number" value="${g.away_score || ''}" data-field="away_score" style="width: 50px;" placeholder="A">
                        </td>
                        <td data-label="Status">
                            <select data-field="status" style="width: 100px;">
                                <option value="scheduled" ${g.status === 'scheduled' ? 'selected' : ''}>Scheduled</option>
                                <option value="live" ${g.status === 'live' ? 'selected' : ''}>Live</option>
                                <option value="final" ${g.status === 'final' ? 'selected' : ''}>Final</option>
                            </select>
                        </td>
                        <td class="actions" data-label="Actions">
                            <div>
                                <button class="btn-edit" onclick="saveGame(${g.id})">üíæ</button>
                                <button class="btn-delete" onclick="deleteGame(${g.id})">üóëÔ∏è</button>
                                <button class="btn-edit" onclick="viewGameDetails(${g.id}, '${g.away_team} @ ${g.home_team}', '${g.game_date}')">üìä Details</button>
                            </div>
                        </td>
                    </tr>
                `).join('');

                updatePaginationUI('games', pag);
            } catch (e) {
                tbody.innerHTML = `<tr><td colspan="6" style="color: var(--accent-red);">Error: ${e.message || e.detail}</td></tr>`;
            }
        }

        function loadCmsGamesPage(direction) {
            const pag = cmsPagination.games;
            pag.offset = Math.max(0, pag.offset + (direction * pag.limit));
            loadCmsGames();
        }

        async function addGame() {
            const homeId = document.getElementById('new-game-home').value;
            const awayId = document.getElementById('new-game-away').value;
            const gameDate = document.getElementById('new-game-date').value;
            const gameTime = document.getElementById('new-game-time').value;
            const season = document.getElementById('new-game-season').value;

            if (!homeId || !awayId || !gameDate) {
                showToast('Home, Away, and Date required', 'error');
                return;
            }

            try {
                await fetch(`${API_BASE}/admin/data/games`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        home_team_id: parseInt(homeId),
                        away_team_id: parseInt(awayId),
                        game_date: gameDate,
                        game_time: gameTime || '19:30',
                        season: season
                    })
                });
                showToast('Game added!');
                hideAddGameForm();
                loadCmsGames();
            } catch (e) {
                showToast('Error adding game', 'error');
            }
        }

        async function saveGame(id) {
            const row = document.querySelector(`#games-table tr[data-id="${id}"]`);
            const data = {};
            row.querySelectorAll('[data-field]').forEach(el => {
                const val = el.value;
                if (el.type === 'number') {
                    data[el.dataset.field] = val ? parseInt(val) : null;
                } else {
                    data[el.dataset.field] = val;
                }
            });

            try {
                await fetch(`${API_BASE}/admin/data/games/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                showToast('Game saved!');
            } catch (e) {
                showToast('Error saving', 'error');
            }
        }

        async function deleteGame(id) {
            if (!confirm('Delete this game?')) return;
            try {
                await fetch(`${API_BASE}/admin/data/games/${id}`, { method: 'DELETE' });
                showToast('Game deleted');
                loadCmsGames();
            } catch (e) {
                showToast('Error deleting', 'error');
            }
        }

        async function viewGameDetails(gameId, matchup, gameDate) {
            try {
                // Fetch player stats for this game
                const response = await fetch(`${API_BASE}/admin/data/player-game-stats?game_id=${gameId}&limit=100`);
                const data = await response.json();

                if (!data.stats || data.stats.length === 0) {
                    alert(`No player stats found for this game.\\n\\nGame: ${matchup}\\nDate: ${gameDate}`);
                    return;
                }

                // Create modal content
                const statsHtml = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 1rem;" onclick="this.remove()">
                        <div style="background: var(--bg-card); border-radius: 16px; padding: 2rem; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; border: 1px solid var(--border);" onclick="event.stopPropagation()">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                                <div>
                                    <h2 style="margin: 0; font-size: 1.5rem;">${matchup}</h2>
                                    <p style="margin: 0.5rem 0 0 0; color: var(--text-muted);">${gameDate}</p>
                                </div>
                                <button onclick="this.closest('div[style*=fixed]').remove()" style="background: var(--bg-secondary); border: 1px solid var(--border); color: var(--text-primary); padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-size: 1.25rem;">‚úï</button>
                            </div>
                            
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="border-bottom: 2px solid var(--border);">
                                            <th style="text-align: left; padding: 0.75rem; color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase;">Player</th>
                                            <th style="text-align: center; padding: 0.75rem; color: var(--text-muted); font-size: 0.75rem;">MIN</th>
                                            <th style="text-align: center; padding: 0.75rem; color: var(--text-muted); font-size: 0.75rem;">PTS</th>
                                            <th style="text-align: center; padding: 0.75rem; color: var(--text-muted); font-size: 0.75rem;">REB</th>
                                            <th style="text-align: center; padding: 0.75rem; color: var(--text-muted); font-size: 0.75rem;">AST</th>
                                            <th style="text-align: center; padding: 0.75rem; color: var(--text-muted); font-size: 0.75rem;">STL</th>
                                            <th style="text-align: center; padding: 0.75rem; color: var(--text-muted); font-size: 0.75rem;">BLK</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data.stats.map(s => `
                                            <tr style="border-bottom: 1px solid var(--border);">
                                                <td style="padding: 0.75rem; font-weight: 500;">${s.player_name || 'Unknown'}</td>
                                                <td style="padding: 0.75rem; text-align: center; font-family: 'JetBrains Mono', monospace;">${s.minutes || '-'}</td>
                                                <td style="padding: 0.75rem; text-align: center; font-family: 'JetBrains Mono', monospace; color: var(--accent-blue); font-weight: 600;">${s.pts || 0}</td>
                                                <td style="padding: 0.75rem; text-align: center; font-family: 'JetBrains Mono', monospace;">${s.reb || 0}</td>
                                                <td style="padding: 0.75rem; text-align: center; font-family: 'JetBrains Mono', monospace;">${s.ast || 0}</td>
                                                <td style="padding: 0.75rem; text-align: center; font-family: 'JetBrains Mono', monospace;">${s.stl || 0}</td>
                                                <td style="padding: 0.75rem; text-align: center; font-family: 'JetBrains Mono', monospace;">${s.blk || 0}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            
                            <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border); color: var(--text-muted); font-size: 0.875rem;">
                                Total players: ${data.stats.length}
                            </div>
                        </div>
                    </div>
                `;

                // Add modal to page
                document.body.insertAdjacentHTML('beforeend', statsHtml);

            } catch (e) {
                console.error('Error loading game details:', e);
                alert('Error loading game details: ' + (e.message || e.detail || 'Unknown error'));
            }
        }

        // PLAYER GAME STATS
        function showAddGameStatsForm() { document.getElementById('add-game-stats-form').style.display = 'block'; }
        function hideAddGameStatsForm() { document.getElementById('add-game-stats-form').style.display = 'none'; }

        async function loadCmsGameStats() {
            const tbody = document.getElementById('game-stats-tbody');
            tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; color: var(--text-muted);">Loading...</td></tr>';

            const search = document.getElementById('game-stats-search-input').value.trim();
            const teamId = document.getElementById('game-stats-filter-team').value;
            const pag = cmsPagination.gameStats;

            let url = `/admin/data/player-game-stats?limit=${pag.limit}&offset=${pag.offset}`;
            if (search) url += `&search=${encodeURIComponent(search)}`;
            if (teamId) url += `&team_id=${teamId}`;

            try {
                const data = await apiCall(url);
                pag.total = data.total || 0;

                if (data.stats.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; color: var(--text-muted);">No game stats found</td></tr>';
                    updatePaginationUI('game-stats', pag);
                    return;
                }

                tbody.innerHTML = data.stats.map(s => `
                    <tr data-id="${s.id}">
                        <td>${s.id}</td>
                        <td>${s.player_name || s.player_id}</td>
                        <td>${s.away_team} @ ${s.home_team}</td>
                        <td>${s.game_date || '-'}</td>
                        <td><input type="number" value="${s.pts}" data-field="pts" style="width: 50px;"></td>
                        <td><input type="number" value="${s.reb}" data-field="reb" style="width: 50px;"></td>
                        <td><input type="number" value="${s.ast}" data-field="ast" style="width: 50px;"></td>
                        <td><input type="number" value="${s.stl}" data-field="stl" style="width: 50px;"></td>
                        <td><input type="number" value="${s.blk}" data-field="blk" style="width: 50px;"></td>
                        <td><input type="text" value="${s.minutes || ''}" data-field="minutes" style="width: 70px;"></td>
                        <td class="actions">
                            <button class="btn-edit" onclick="saveGameStats(${s.id})">üíæ</button>
                            <button class="btn-delete" onclick="deleteGameStats(${s.id})">üóëÔ∏è</button>
                        </td>
                    </tr>
                `).join('');

                updatePaginationUI('game-stats', pag);
            } catch (e) {
                tbody.innerHTML = `<tr><td colspan="11" style="color: var(--accent-red);">Error: ${e.message || e.detail}</td></tr>`;
            }
        }

        function loadCmsGameStatsPage(direction) {
            const pag = cmsPagination.gameStats;
            pag.offset = Math.max(0, pag.offset + (direction * pag.limit));
            loadCmsGameStats();
        }

        async function addGameStats() {
            const playerId = document.getElementById('new-game-stats-player-id').value;
            const gameId = document.getElementById('new-game-stats-game-id').value;

            if (!playerId || !gameId) {
                showToast('Player ID and Game ID required', 'error');
                return;
            }

            try {
                await fetch(`${API_BASE}/admin/data/player-game-stats`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        player_id: parseInt(playerId),
                        game_id: parseInt(gameId),
                        pts: parseInt(document.getElementById('new-game-stats-pts').value) || 0,
                        reb: parseInt(document.getElementById('new-game-stats-reb').value) || 0,
                        ast: parseInt(document.getElementById('new-game-stats-ast').value) || 0,
                        stl: parseInt(document.getElementById('new-game-stats-stl').value) || 0,
                        blk: parseInt(document.getElementById('new-game-stats-blk').value) || 0,
                        minutes: document.getElementById('new-game-stats-minutes').value || null
                    })
                });
                showToast('Game stats added!');
                hideAddGameStatsForm();
                loadCmsGameStats();
            } catch (e) {
                showToast('Error adding game stats', 'error');
            }
        }

        async function saveGameStats(id) {
            const row = document.querySelector(`#game-stats-table tr[data-id="${id}"]`);
            const data = {};
            row.querySelectorAll('input[data-field]').forEach(input => {
                const value = input.value.trim();
                if (input.type === 'number') {
                    data[input.dataset.field] = value ? parseInt(value) : 0;
                } else {
                    data[input.dataset.field] = value || null;
                }
            });

            try {
                await fetch(`${API_BASE}/admin/data/player-game-stats/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                showToast('Game stats saved!');
            } catch (e) {
                showToast('Error saving', 'error');
            }
        }

        async function deleteGameStats(id) {
            if (!confirm('Delete these game stats?')) return;
            try {
                await fetch(`${API_BASE}/admin/data/player-game-stats/${id}`, { method: 'DELETE' });
                showToast('Game stats deleted');
                loadCmsGameStats();
            } catch (e) {
                showToast('Error deleting', 'error');
            }
        }

        // STANDINGS
        async function loadCmsStandings() {
            const tbody = document.getElementById('standings-tbody');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-muted);">Loading...</td></tr>';

            try {
                const data = await apiCall('/admin/data/standings');
                if (data.standings.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-muted);">No standings found</td></tr>';
                    return;
                }

                tbody.innerHTML = data.standings.map(s => `
                    <tr data-team-id="${s.team_id}">
                        <td>${s.team} - ${s.team_name}</td>
                        <td><input type="number" value="${s.wins}" data-field="wins" style="width: 50px;"></td>
                        <td><input type="number" value="${s.losses}" data-field="losses" style="width: 50px;"></td>
                        <td><input type="number" value="${s.conference_rank || ''}" data-field="conference_rank" style="width: 50px;"></td>
                        <td><input type="text" value="${s.streak || ''}" data-field="streak" style="width: 60px;"></td>
                        <td class="actions">
                            <button class="btn-edit" onclick="saveStandings(${s.team_id})">üíæ</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                tbody.innerHTML = `<tr><td colspan="6" style="color: var(--accent-red);">Error: ${e.message || e.detail}</td></tr>`;
            }
        }

        async function saveStandings(teamId) {
            const row = document.querySelector(`#standings-table tr[data-team-id="${teamId}"]`);
            const data = {};
            row.querySelectorAll('input[data-field]').forEach(input => {
                if (input.type === 'number') {
                    data[input.dataset.field] = input.value ? parseInt(input.value) : null;
                } else {
                    data[input.dataset.field] = input.value || null;
                }
            });

            try {
                await fetch(`${API_BASE}/admin/data/standings/${teamId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                showToast('Standings saved!');
            } catch (e) {
                showToast('Error saving', 'error');
            }
        }

        // Reset pagination when filters change
        document.getElementById('players-search-input')?.addEventListener('input', () => {
            cmsPagination.players.offset = 0;
        });
        document.getElementById('players-filter-team')?.addEventListener('change', () => {
            cmsPagination.players.offset = 0;
        });
        document.getElementById('stats-search-input')?.addEventListener('input', () => {
            cmsPagination.stats.offset = 0;
        });
        document.getElementById('stats-filter-team')?.addEventListener('change', () => {
            cmsPagination.stats.offset = 0;
        });
        document.getElementById('games-filter-team')?.addEventListener('change', () => {
            cmsPagination.games.offset = 0;
        });
        document.getElementById('games-filter-status')?.addEventListener('change', () => {
            cmsPagination.games.offset = 0;
        });
        document.getElementById('game-stats-search-input')?.addEventListener('input', () => {
            cmsPagination.gameStats.offset = 0;
        });
        document.getElementById('game-stats-filter-team')?.addEventListener('change', () => {
            cmsPagination.gameStats.offset = 0;
        });

        // Cron runs filter listeners
        document.getElementById('cron-runs-filter-job')?.addEventListener('change', () => {
            cronRunsPagination.offset = 0;
        });
        document.getElementById('cron-runs-filter-status')?.addEventListener('change', () => {
            cronRunsPagination.offset = 0;
        });

        // =====================
        // CRON MANAGEMENT FUNCTIONS
        // =====================

        const cronRunsPagination = { offset: 0, limit: 50, total: 0 };

        // Format date to readable format: "7:35PM, 8 Dec 2025"
        function formatReadableDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return 'Invalid Date';

            const hours = date.getHours();
            const minutes = date.getMinutes();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const displayHours = hours % 12 || 12;
            const displayMinutes = minutes.toString().padStart(2, '0');

            const day = date.getDate();
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const month = monthNames[date.getMonth()];
            const year = date.getFullYear();

            return `${displayHours}:${displayMinutes}${ampm}, ${day} ${month} ${year}`;
        }

        async function loadCronJobs() {
            const tbody = document.getElementById('cron-jobs-tbody');
            tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--text-muted);">Loading...</td></tr>';

            try {
                // Cleanup stuck jobs first (wait for it to complete)
                try {
                    await fetch(`${API_BASE}/admin/cron/cleanup-stuck`, { method: 'POST' });
                } catch (e) {
                    // Ignore cleanup errors
                }

                const data = await apiCall('/admin/cron/jobs');

                if (data.jobs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--text-muted);">No cron jobs found</td></tr>';
                    return;
                }

                // Populate job filter dropdown
                const jobFilter = document.getElementById('cron-runs-filter-job');
                if (jobFilter) {
                    jobFilter.innerHTML = '<option value="">All Jobs</option>' +
                        data.jobs.map(j => `<option value="${j.name}">${j.name}</option>`).join('');
                }

                tbody.innerHTML = data.jobs.map(job => {
                    const statusBadge = job.is_active
                        ? '<span style="color: var(--accent-green);">‚óè Active</span>'
                        : '<span style="color: var(--text-muted);">‚óã Inactive</span>';

                    const successColor = job.success_rate >= 90 ? 'var(--accent-green)' :
                        job.success_rate >= 70 ? 'var(--accent-yellow)' : 'var(--accent-red)';

                    return `
                        <tr data-job-id="${job.id}">
                            <td>
                                <strong>${job.name}</strong>
                                ${job.description ? `<span style="margin-left: 0.5rem; cursor: help; color: var(--text-muted);" title="${job.description}">‚ÑπÔ∏è</span>` : ''}
                            </td>
                            <td>${job.schedule}</td>
                            <td>${statusBadge}</td>
                            <td>${job.last_run ? formatReadableDate(job.last_run) : 'Never'}</td>
                            <td>${job.next_run ? formatReadableDate(job.next_run) : 'N/A'}</td>
                            <td>${job.total_runs}</td>
                            <td><span style="color: ${successColor};">${job.success_rate}%</span><br><small>${job.successful_runs}/${job.total_runs}</small></td>
                            <td class="actions sticky-actions" style="vertical-align: middle; text-align: center;">
                                <div style="display: inline-flex; gap: 0.5rem; align-items: center; justify-content: center; vertical-align: middle;">
                                    <button class="btn-edit" onclick="triggerCronJob(${job.id}, '${job.name}')" title="‚ñ∂Ô∏è Run Now - Manually trigger this job immediately">‚ñ∂Ô∏è Run</button>
                                    <button class="btn-edit" onclick="toggleCronJob(${job.id})" title="${job.is_active ? '‚è∏Ô∏è Pause - Disable automatic scheduling' : '‚ñ∂Ô∏è Resume - Enable automatic scheduling'}">${job.is_active ? '‚è∏Ô∏è Pause' : '‚ñ∂Ô∏è Resume'}</button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (e) {
                tbody.innerHTML = `<tr><td colspan="8" style="color: var(--accent-red);">Error: ${e.message || e.detail}</td></tr>`;
            }
        }

        async function loadCronRuns() {
            const tbody = document.getElementById('cron-runs-tbody');
            tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--text-muted);">Loading...</td></tr>';

            // Cleanup stuck jobs first
            try {
                await fetch(`${API_BASE}/admin/cron/cleanup-stuck`, { method: 'POST' });
            } catch (e) {
                // Ignore cleanup errors
            }

            const jobName = document.getElementById('cron-runs-filter-job')?.value;
            const status = document.getElementById('cron-runs-filter-status')?.value;
            const pag = cronRunsPagination;

            let url = `/admin/cron/runs?limit=${pag.limit}&offset=${pag.offset}`;
            if (jobName) url += `&job_name=${encodeURIComponent(jobName)}`;
            if (status) url += `&status=${status}`;

            try {
                const data = await apiCall(url);
                pag.total = data.total || 0;

                let runs = data.runs;

                if (runs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--text-muted);">No runs found</td></tr>';
                    updateCronRunsPaginationUI(pag);
                    return;
                }

                tbody.innerHTML = runs.map(run => {
                    // Check if job is actually stuck (running for more than 1 hour)
                    let isRunning = run.status === 'running';
                    let isStuck = false;
                    if (isRunning && run.started_at) {
                        const elapsed = Math.floor((new Date() - new Date(run.started_at)) / 1000);
                        const elapsedHours = elapsed / 3600;
                        isStuck = elapsedHours > 1; // Stuck if running for more than 1 hour
                        // If stuck, mark as failed in UI (but don't change DB yet - cleanup will do that)
                        if (isStuck) {
                            isRunning = false; // Don't show as running if stuck
                        }
                    }

                    const statusColor = run.status === 'success' ? 'var(--accent-green)' :
                        run.status === 'failed' || isStuck ? 'var(--accent-red)' : 'var(--accent-yellow)';

                    let duration = run.duration_seconds ? `${run.duration_seconds}s` : '-';
                    let statusDisplay = run.status.toUpperCase();
                    if (isStuck) {
                        statusDisplay = 'STUCK';
                        const elapsed = Math.floor((new Date() - new Date(run.started_at)) / 1000);
                        duration = `${Math.floor(elapsed / 3600)}h ${Math.floor((elapsed % 3600) / 60)}m (stuck)`;
                    } else if (run.status === 'running') {
                        // Calculate elapsed time
                        const elapsed = Math.floor((new Date() - new Date(run.started_at)) / 1000);
                        duration = `${Math.floor(elapsed / 60)}m ${elapsed % 60}s (running)`;
                    }

                    const rowStyle = (run.status === 'running' && !isStuck) ? 'background: rgba(255, 193, 7, 0.1); font-weight: 500;' :
                        isStuck ? 'background: rgba(255, 0, 0, 0.1); font-weight: 500;' : '';

                    // Format trigger source
                    const triggerIcon = run.triggered_by === 'manual' ? 'üë§' : '‚è∞';
                    const triggerText = run.triggered_by === 'manual' ? 'Manual' : 'Cron';
                    const triggerColor = run.triggered_by === 'manual' ? 'var(--accent-blue)' : 'var(--text-muted)';

                    return `
                        <tr style="${rowStyle}">
                            <td><strong>${run.job_name}</strong>${(run.status === 'running' && !isStuck) ? ' <span style="color: var(--accent-yellow);">‚è≥</span>' : ''}${isStuck ? ' <span style="color: var(--accent-red);">‚ö†Ô∏è STUCK</span>' : ''}</td>
                            <td><span style="color: ${triggerColor}; font-weight: 500;">${triggerIcon} ${triggerText}</span></td>
                            <td>${formatReadableDate(run.started_at)}</td>
                            <td>${duration}</td>
                            <td><span style="color: ${statusColor}; font-weight: ${(run.status === 'running' && !isStuck) ? 'bold' : 'normal'};">${statusDisplay}</span></td>
                            <td>${run.items_updated || 0}</td>
                            <td style="text-align: center;">
                                ${run.details ? `<button class="btn-view-details" onclick="viewRunDetails(${run.id})" title="View Full Details">üëÅÔ∏è View</button>` : '-'}
                            </td>
                            <td style="vertical-align: middle;">
                                <div style="display: inline-flex; gap: 0.5rem; flex-wrap: wrap; align-items: center; vertical-align: middle;">
                                    ${(run.status === 'running' && !isStuck) ? `
                                        <button class="btn-edit" onclick="startWatchingLogs(${run.id}, '${run.job_name}')" title="üìã View Live Logs">üìã Logs</button>
                                        <button class="btn-delete" onclick="stopCronRun(${run.id})" title="‚èπÔ∏è Stop Running Job">‚èπÔ∏è Stop</button>
                                    ` : `
                                        <button class="btn-edit" onclick="startWatchingLogs(${run.id}, '${run.job_name}')" title="üìã View Logs">üìã Logs</button>
                                    `}
                                    ${isStuck ? `<button class="btn-delete" onclick="stopCronRun(${run.id})" title="‚èπÔ∏è Force Stop Stuck Job">‚èπÔ∏è Force Stop</button>` : ''}
                                    <button class="btn-delete" onclick="deleteCronRun(${run.id})" title="üóëÔ∏è Delete This Run">üóëÔ∏è</button>
                                </div>
                                ${run.error_message || isStuck ? `<div style="color: var(--accent-red); font-size: 0.75rem; line-height: 1.4; margin-top: 0.5rem; white-space: normal;">${run.error_message || 'Job appears to be stuck (running for over 1 hour)'}</div>` : ''}
                            </td>
                        </tr>
                    `;
                }).join('');

                // Auto-refresh if there are running jobs
                const hasRunning = runs.some(r => r.status === 'running');
                if (hasRunning && !logWatchInterval) {
                    // Refresh runs every 5 seconds if there are running jobs
                    setTimeout(loadCronRuns, 5000);
                }

                updateCronRunsPaginationUI(pag);
            } catch (e) {
                tbody.innerHTML = `<tr><td colspan="8" style="color: var(--accent-red);">Error: ${e.message || e.detail}</td></tr>`;
            }
        }

        function loadCronRunsPage(direction) {
            const pag = cronRunsPagination;
            pag.offset = Math.max(0, pag.offset + (direction * pag.limit));
            loadCronRuns();
        }

        function updateCronRunsPaginationUI(pag) {
            const infoEl = document.getElementById('cron-runs-pagination-info');
            const prevBtn = document.getElementById('cron-runs-prev');
            const nextBtn = document.getElementById('cron-runs-next');

            if (infoEl) {
                const start = pag.offset + 1;
                const end = Math.min(pag.offset + pag.limit, pag.total);
                infoEl.textContent = `Showing ${start}-${end} of ${pag.total}`;
            }

            if (prevBtn) prevBtn.disabled = pag.offset === 0;
            if (nextBtn) nextBtn.disabled = pag.offset + pag.limit >= pag.total;
        }

        let logWatchInterval = null;
        let watchedRunId = null;

        async function triggerCronJob(jobId, jobName) {
            // Show modal with options
            const options = await showTriggerCronModal(jobId, jobName);
            if (!options) return; // Cancelled

            const { hoursBack, force, teamId, limit } = options;

            try {
                const params = new URLSearchParams();
                if (jobName === 'update_finished_games' && hoursBack) {
                    params.append('hours_back', hoursBack.toString());
                }
                if (jobName === 'update_team_results') {
                    if (teamId) params.append('team_id', teamId);
                    if (limit !== null) params.append('limit', limit);
                }
                if (force) {
                    params.append('force', 'true');
                }

                const response = await fetch(`${API_BASE}/admin/cron/jobs/${jobId}/trigger?${params.toString()}`, { method: 'POST' });
                if (!response.ok) throw new Error('Failed to trigger job');

                showToast('Cron job triggered! Watching logs...');

                // Wait a moment for the run to be created, then find it and watch logs
                setTimeout(async () => {
                    await loadCronRuns();
                    // Find the most recent running job for this job name
                    const runs = await fetch(`${API_BASE}/admin/cron/runs?limit=5&status=running`).then(r => r.json()).then(d => d.runs || []);
                    const recentRun = runs.find(r => r.job_name === jobName);
                    if (recentRun) {
                        startWatchingLogs(recentRun.id, jobName);
                    } else {
                        // Try again after a bit more time
                        setTimeout(async () => {
                            const runs2 = await fetch(`${API_BASE}/admin/cron/runs?limit=5&status=running`).then(r => r.json()).then(d => d.runs || []);
                            const recentRun2 = runs2.find(r => r.job_name === jobName);
                            if (recentRun2) {
                                startWatchingLogs(recentRun2.id, jobName);
                            }
                        }, 2000);
                    }
                }, 1000);

                setTimeout(() => {
                    loadCronJobs();
                    loadCronRuns();
                }, 2000);
            } catch (e) {
                showToast('Error triggering job: ' + (e.message || e), 'error');
            }
        }

        function startWatchingLogs(runId, jobName) {
            watchedRunId = runId;
            document.getElementById('running-job-name').textContent = jobName;
            document.getElementById('running-job-logs').style.display = 'block';

            // Scroll to logs section
            document.getElementById('running-job-logs').scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            // Load logs immediately
            refreshRunningJobLogs();

            // Only start polling if job is still running (will be checked in refreshRunningJobLogs)
            if (logWatchInterval) clearInterval(logWatchInterval);
            // Start polling - refreshRunningJobLogs will stop it if job is completed
            logWatchInterval = setInterval(refreshRunningJobLogs, 2000); // Poll every 2 seconds
        }

        function stopWatchingLogs() {
            if (logWatchInterval) {
                clearInterval(logWatchInterval);
                logWatchInterval = null;
            }
            watchedRunId = null;
            document.getElementById('running-job-logs').style.display = 'none';
        }

        async function refreshRunningJobLogs() {
            if (!watchedRunId) return;

            try {
                const data = await apiCall(`/admin/cron/runs/${watchedRunId}/logs`);
                const logContent = document.getElementById('running-job-log-content');

                let logText = `Status: ${data.status}\n`;
                logText += `Started: ${new Date(data.started_at).toLocaleString()}\n`;

                if (data.is_running) {
                    logText += `Elapsed: ${Math.floor((data.elapsed_seconds || 0) / 60)}m ${(data.elapsed_seconds || 0) % 60}s\n`;
                    logText += `‚è≥ Running...\n\n`;
                } else {
                    logText += `Completed: ${data.completed_at ? new Date(data.completed_at).toLocaleString() : 'N/A'}\n`;
                    logText += `Duration: ${data.duration_seconds || 0}s\n`;
                    logText += `Items Updated: ${data.items_updated || 0}\n`;
                    if (data.error_message) {
                        logText += `Error: ${data.error_message}\n`;
                    }
                    logText += `\n`;

                    // Stop polling if job completed, but keep logs visible
                    if (logWatchInterval) {
                        clearInterval(logWatchInterval);
                        logWatchInterval = null;
                    }
                }

                // Display logs from details.logs array if available
                if (data.details && data.details.logs && Array.isArray(data.details.logs)) {
                    logText += `\nüìã ${data.is_running ? 'Live' : 'Completed'} Logs:\n`;
                    logText += `${data.details.logs.join('\n')}\n\n`;
                } else if (!data.is_running) {
                    logText += `\nüìã No logs available for this run.\n`;
                } else if (data.details && data.is_running) {
                    // Fallback to JSON if logs array not available (for running jobs)
                    logText += `\nDetails:\n${JSON.stringify(data.details, null, 2)}\n\n`;
                }

                logContent.textContent = logText;

                // Only auto-scroll if user is already at bottom (or close to it)
                const container = logContent.parentElement;
                const isNearBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 50;
                if (isNearBottom) {
                    container.scrollTop = container.scrollHeight;
                }

            } catch (e) {
                document.getElementById('running-job-log-content').textContent = `Error loading logs: ${e.message || e}`;
            }
        }

        async function toggleCronJob(jobId) {
            try {
                const response = await fetch(`${API_BASE}/admin/cron/jobs/${jobId}/toggle`, { method: 'PUT' });
                const data = await response.json();
                showToast(data.message);
                loadCronJobs();
            } catch (e) {
                showToast('Error toggling job', 'error');
            }
        }

        async function stopCronRun(runId) {
            const confirmed = await showCustomModal(
                '‚èπÔ∏è Stop Running Job',
                'Stop this cron job? Any uncommitted database changes will be rolled back.',
                'Stop Job',
                true
            );
            if (!confirmed) return;

            try {
                const response = await fetch(`${API_BASE}/admin/cron/runs/${runId}/stop`, { method: 'POST' });

                let data;
                try {
                    data = await response.json();
                } catch (jsonError) {
                    // If response is not JSON, try to get text
                    const text = await response.text();
                    throw new Error(`Server error (${response.status}): ${text.substring(0, 200)}`);
                }

                if (!response.ok) {
                    throw new Error(data.detail || data.message || `HTTP ${response.status}: Failed to stop job`);
                }

                showToast(data.message || 'Job stopped successfully');

                // Stop watching logs if we were watching this run
                if (watchedRunId === runId) {
                    stopWatchingLogs();
                }

                // Refresh runs immediately to show updated status
                await loadCronRuns();
                await loadCronJobs();
            } catch (e) {
                const errorMsg = e.message || e.toString() || 'Unknown error';
                showToast('Error stopping job: ' + errorMsg, 'error');
                console.error('Error stopping cron run:', e);
                // Still refresh to see current state
                await loadCronRuns();
            }
        }

        async function deleteCronRun(runId) {
            const confirmed = await showCustomModal(
                'üóëÔ∏è Delete Cron Run',
                'Delete this cron run record? This action cannot be undone.',
                'Delete',
                true
            );
            if (!confirmed) return;

            try {
                const response = await fetch(`${API_BASE}/admin/cron/runs/${runId}`, { method: 'DELETE' });

                let data;
                try {
                    data = await response.json();
                } catch (jsonError) {
                    // If response is not JSON, try to get text
                    const text = await response.text();
                    throw new Error(`Server error (${response.status}): ${text.substring(0, 200)}`);
                }

                if (!response.ok) {
                    throw new Error(data.detail || data.message || `HTTP ${response.status}: Failed to delete run`);
                }

                showToast(data.message || 'Run deleted successfully');

                // Stop watching logs if we were watching this run
                if (watchedRunId === runId) {
                    stopWatchingLogs();
                }

                // Refresh runs
                await loadCronRuns();
            } catch (e) {
                const errorMsg = e.message || e.toString() || 'Unknown error';
                showToast('Error deleting run: ' + errorMsg, 'error');
                console.error('Error deleting cron run:', e);
                await loadCronRuns();
            }
        }

        // Initial load
        loadAllWidgets();
        loadDbStats();
        loadAllWidgets();
        loadDbStats();
        loadCmsPlayers();  // Pre-load CMS data
        initPlayerSearch(); // Load roster and setup search
        setInterval(updateMetrics, 10000);

        // ============================================
        // Auto-Refresh for Cron Jobs List
        // ============================================
        let jobsRefreshInterval = null;
        let hasRunningJobs = false;

        function startJobsAutoRefresh() {
            if (jobsRefreshInterval) return; // Already running

            console.log('üîÑ Starting auto-refresh for jobs list');
            jobsRefreshInterval = setInterval(async () => {
                await refreshJobsList();
            }, 5000); // Refresh every 5 seconds
        }

        function stopJobsAutoRefresh() {
            if (jobsRefreshInterval) {
                console.log('‚èπÔ∏è Stopping auto-refresh for jobs list');
                clearInterval(jobsRefreshInterval);
                jobsRefreshInterval = null;
            }
        }

        async function refreshJobsList() {
            try {
                // Check if we should continue auto-refresh
                const stillHasRunningJobs = await checkForRunningJobs();

                if (stillHasRunningJobs) {
                    // Reload the jobs to update their status
                    await loadCronJobs();
                }

                if (!stillHasRunningJobs && hasRunningJobs) {
                    // All jobs completed, stop auto-refresh
                    hasRunningJobs = false;
                    stopJobsAutoRefresh();
                    console.log('‚úÖ All jobs completed, stopped auto-refresh');

                    // Final refresh to show completed status
                    await loadCronJobs();
                }

                hasRunningJobs = stillHasRunningJobs;

            } catch (error) {
                console.error('Error refreshing jobs list:', error);
            }
        }

        async function checkForRunningJobs() {
            try {
                const response = await fetch('/api/admin/cron/runs?limit=20&status=running');
                const data = await response.json();
                return data.runs && data.runs.length > 0;
            } catch (error) {
                console.error('Error checking for running jobs:', error);
                return false;
            }
        }

        // Wrap the original triggerJob function to start auto-refresh
        const originalTriggerJob = window.triggerJob;
        window.triggerJob = async function (jobId, jobName) {
            // Call original function
            if (originalTriggerJob) {
                await originalTriggerJob(jobId, jobName);
            }

            // Start auto-refresh
            hasRunningJobs = true;
            startJobsAutoRefresh();

            console.log('üöÄ Started job:', jobName, '- Auto-refresh enabled');
        };

        // Check for running jobs on page load and start auto-refresh if needed
        (async function checkInitialRunningJobs() {
            const hasRunning = await checkForRunningJobs();
            if (hasRunning) {
                console.log('üìä Found running jobs on page load - starting auto-refresh');
                hasRunningJobs = true;
                startJobsAutoRefresh();
            }
        })();

        // ============================================
        // Mobile Table to Card Conversion
        // ============================================
        function addDataLabelsToTables() {
            // Find all tables with class cms-table
            const tables = document.querySelectorAll('.cms-table');

            tables.forEach(table => {
                // Get all header cells
                const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());

                // Get all body rows
                const rows = table.querySelectorAll('tbody tr');

                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    cells.forEach((cell, index) => {
                        // Add data-label attribute with the corresponding header text
                        if (headers[index]) {
                            cell.setAttribute('data-label', headers[index]);
                        }
                    });
                });
            });
        }

        // Call this function after tables are populated
        // We'll need to call it in each load function
        function initMobileTables() {
            addDataLabelsToTables();
        }

        // Add to initial load
        initMobileTables();

        // Also call after any table updates
        const originalLoadCronJobs = window.loadCronJobs;
        if (originalLoadCronJobs) {
            window.loadCronJobs = async function () {
                await originalLoadCronJobs();
                addDataLabelsToTables();
            };
        }

        const originalLoadCronRuns = window.loadCronRuns;
        if (originalLoadCronRuns) {
            window.loadCronRuns = async function () {
                await originalLoadCronRuns();
                addDataLabelsToTables();
            };
        }

        const originalLoadCmsPlayers = window.loadCmsPlayers;
        if (originalLoadCmsPlayers) {
            window.loadCmsPlayers = async function () {
                await originalLoadCmsPlayers();
                addDataLabelsToTables();
            };
        }

        const originalLoadCmsGames = window.loadCmsGames;
        if (originalLoadCmsGames) {
            window.loadCmsGames = async function () {
                await originalLoadCmsGames();
                addDataLabelsToTables();
            };
        }

        const originalLoadCmsStats = window.loadCmsStats;
        if (originalLoadCmsStats) {
            window.loadCmsStats = async function () {
                await originalLoadCmsStats();
                addDataLabelsToTables();
            };
        }

        const originalLoadCmsPlayerGameStats = window.loadCmsPlayerGameStats;
        if (originalLoadCmsPlayerGameStats) {
            window.loadCmsPlayerGameStats = async function () {
                await originalLoadCmsPlayerGameStats();
                addDataLabelsToTables();
            };
        }

        const originalLoadCmsStandings = window.loadCmsStandings;
        if (originalLoadCmsStandings) {
            window.loadCmsStandings = async function () {
                await originalLoadCmsStandings();
                addDataLabelsToTables();
            };
        }

        console.log('üì± Mobile table-to-card conversion initialized');
    </script>
</body>

</html>